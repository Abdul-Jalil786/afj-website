name: Deploy Validation

on:
  # Trigger after push to main (Railway auto-deploys on push)
  push:
    branches: [main]
    paths-ignore:
      - 'src/data/reports/**'
      - 'src/data/notifications.json'
      - 'src/data/proposed-fixes.json'
      - 'src/data/blog-drafts.json'
      - 'src/data/social-drafts.json'
  workflow_dispatch: # Allow manual trigger

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    # Wait for Railway to build and deploy
    steps:
      - name: Wait for deployment
        run: sleep 120

      - name: Check key pages return 200
        id: page_checks
        run: |
          SITE="${{ secrets.SITE_URL }}"
          PAGES=(
            "/"
            "/blog"
            "/services"
            "/quote"
            "/compliance"
            "/faq"
            "/areas"
            "/services/send-transport"
          )

          FAILED=""
          RESULTS=""

          for page in "${PAGES[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "${SITE}${page}")
            if [ "$STATUS" -ne "200" ]; then
              FAILED="${FAILED}${page} (${STATUS})\n"
              RESULTS="${RESULTS}| ${page} | ${STATUS} | FAIL |\n"
            else
              RESULTS="${RESULTS}| ${page} | ${STATUS} | OK |\n"
            fi
          done

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -n "$FAILED" ]; then
            echo "failed<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FAILED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_failures=true" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
          fi

      - name: Check sitemap
        id: sitemap_check
        run: |
          SITE="${{ secrets.SITE_URL }}"

          # Check sitemap index exists
          SITEMAP_STATUS=$(curl -s -o /tmp/sitemap.xml -w "%{http_code}" --max-time 15 "${SITE}/sitemap-index.xml")

          if [ "$SITEMAP_STATUS" -ne "200" ]; then
            echo "sitemap_ok=false" >> $GITHUB_OUTPUT
            echo "sitemap_msg=Sitemap returned status ${SITEMAP_STATUS}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Count URLs in the sitemap (rough count of <loc> tags)
          URL_COUNT=$(grep -c "<loc>" /tmp/sitemap.xml 2>/dev/null || echo "0")

          # We expect at least 30 URLs (homepage + services + areas + blog + misc)
          if [ "$URL_COUNT" -lt 5 ]; then
            echo "sitemap_ok=false" >> $GITHUB_OUTPUT
            echo "sitemap_msg=Sitemap has only ${URL_COUNT} entries (expected 30+)" >> $GITHUB_OUTPUT
          else
            echo "sitemap_ok=true" >> $GITHUB_OUTPUT
            echo "sitemap_msg=Sitemap valid with ${URL_COUNT} entries" >> $GITHUB_OUTPUT
          fi

      - name: Send failure notification via Resend
        if: steps.page_checks.outputs.has_failures == 'true' || steps.sitemap_check.outputs.sitemap_ok == 'false'
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
        run: |
          EMAIL="${NOTIFICATION_EMAIL:-info@afjltd.co.uk}"

          # Build failure details
          DETAILS=""
          if [ "${{ steps.page_checks.outputs.has_failures }}" == "true" ]; then
            DETAILS="<h3>Page Failures</h3><pre>${{ steps.page_checks.outputs.failed }}</pre>"
          fi
          if [ "${{ steps.sitemap_check.outputs.sitemap_ok }}" == "false" ]; then
            DETAILS="${DETAILS}<h3>Sitemap Issue</h3><p>${{ steps.sitemap_check.outputs.sitemap_msg }}</p>"
          fi

          if [ -n "$RESEND_API_KEY" ]; then
            curl -s -X POST https://api.resend.com/emails \
              -H "Authorization: Bearer ${RESEND_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "{
                \"from\": \"AFJ Deploy Monitor <noreply@afjltd.co.uk>\",
                \"to\": [\"${EMAIL}\"],
                \"subject\": \"AFJ Website Deploy Validation Failed\",
                \"html\": \"<div style='font-family:Arial,sans-serif;max-width:600px;margin:0 auto'><div style='background:#E53E3E;color:white;padding:20px;border-radius:8px 8px 0 0'><h1 style='margin:0;font-size:20px'>Deploy Validation Failed</h1></div><div style='padding:24px;border:1px solid #e2e8f0;border-top:none;border-radius:0 0 8px 8px'><p>The post-deploy validation for <strong>afjltd.co.uk</strong> has detected issues:</p>${DETAILS}<hr style='border:none;border-top:1px solid #e2e8f0;margin:20px 0'/><p style='font-size:12px;color:#718096'>Automated alert from deploy-validate.yml</p></div></div>\"
              }"
            echo "Notification sent to ${EMAIL}"
          else
            echo "RESEND_API_KEY not set â€” skipping email notification"
          fi

      - name: Report results
        run: |
          echo "## Page Check Results"
          echo "| Page | Status | Result |"
          echo "|------|--------|--------|"
          echo -e "${{ steps.page_checks.outputs.results }}"
          echo ""
          echo "## Sitemap: ${{ steps.sitemap_check.outputs.sitemap_msg }}"

      - name: Fail if checks failed
        if: steps.page_checks.outputs.has_failures == 'true' || steps.sitemap_check.outputs.sitemap_ok == 'false'
        run: |
          echo "Deploy validation failed. See details above."
          exit 1
