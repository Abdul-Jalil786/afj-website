---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import departments from '../../data/departments.json';

// Read Cloudflare Zero Trust JWT to identify logged-in user
const cfJwt = Astro.request.headers.get('Cf-Access-Jwt-Assertion') || '';
const userEmail = Astro.request.headers.get('Cf-Access-Authenticated-User-Email') || 'unknown';

// Determine user's department
type DeptKey = keyof typeof departments;
let userDepartment: DeptKey = 'management';
let departmentName = 'Management';
let canApprove = true;

for (const [key, dept] of Object.entries(departments) as [DeptKey, typeof departments[DeptKey]][]) {
  if (dept.emails.includes(userEmail)) {
    userDepartment = key;
    departmentName = dept.name;
    canApprove = dept.canApprove;
    break;
  }
}

const quickActions = [
  {
    title: 'Create Blog Post',
    description: 'Use AI to draft a blog post in AFJ\'s brand voice. Enter a topic and key points — the AI generates the draft for you to review.',
    href: '/admin/content',
    icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z',
    colour: 'bg-afj-accent',
  },
  {
    title: 'Update Page Content',
    description: 'Describe what you want changed in plain English. The AI will generate the edits for your approval before publishing.',
    href: '/admin/pages',
    icon: 'M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z',
    colour: 'bg-blue-600',
  },
  {
    title: 'View Approvals',
    description: canApprove
      ? 'Review and approve pending blog posts and page changes submitted by your team.'
      : 'View the status of content you\'ve submitted for approval.',
    href: '/admin/approvals',
    icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
    colour: 'bg-amber-500',
  },
  {
    title: 'Compliance Editor',
    description: 'Update compliance figures — CQC rating, DBS checks, MOT pass rates, insurance status, and more.',
    href: '/admin/compliance',
    icon: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z',
    colour: 'bg-teal-600',
  },
  {
    title: 'Testimonials & Case Studies',
    description: 'Paste raw customer feedback and let AI generate polished testimonials and case studies.',
    href: '/admin/testimonials',
    icon: 'M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z',
    colour: 'bg-purple-600',
  },
  {
    title: 'Back to Website',
    description: 'Return to the public-facing AFJ website.',
    href: '/',
    icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6',
    colour: 'bg-gray-600',
  },
];
---

<AdminLayout title="Dashboard" userEmail={userEmail}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Welcome -->
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-gray-900">Welcome back</h1>
      <p class="text-gray-600 mt-1">
        Logged in as <span class="font-medium text-afj-dark-blue">{userEmail}</span>
        &middot; Department: <span class="font-medium text-afj-accent">{departmentName}</span>
      </p>
    </div>

    <!-- Quick Actions Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {quickActions.map((action) => (
        <a href={action.href} class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow group block">
          <div class="flex items-start gap-4">
            <div class:list={['flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center', action.colour]}>
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={action.icon} />
              </svg>
            </div>
            <div>
              <h2 class="text-lg font-semibold text-gray-900 group-hover:text-afj-accent transition-colors">{action.title}</h2>
              <p class="text-gray-600 text-sm mt-1">{action.description}</p>
            </div>
          </div>
        </a>
      ))}
    </div>

    <!-- Department Info -->
    <div class="mt-8 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-3">Your Access</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
        <div>
          <span class="text-gray-500">Department</span>
          <p class="font-medium text-gray-900">{departmentName}</p>
        </div>
        <div>
          <span class="text-gray-500">Approval Permission</span>
          <p class="font-medium text-gray-900">{canApprove ? 'Can approve content' : 'Submit for approval'}</p>
        </div>
        <div>
          <span class="text-gray-500">Editable Pages</span>
          <p class="font-medium text-gray-900">
            {departments[userDepartment].pages[0] === 'all' ? 'All pages' : `${departments[userDepartment].pages.length} page(s)`}
          </p>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>
