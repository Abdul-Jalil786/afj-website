---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import departments from '../../data/departments.json';
import { authenticateRequest } from '../../lib/cf-auth';

const userEmail = await authenticateRequest(Astro.request);
if (!userEmail) {
  return new Response('<h1>Access Denied</h1><p>You must be authenticated via Cloudflare Zero Trust to access the admin dashboard.</p><p><a href="/">Return to website</a></p>', { status: 403, headers: { 'Content-Type': 'text/html' } });
}

type DeptKey = keyof typeof departments;
let userDepartment: DeptKey = 'management';

for (const [key, dept] of Object.entries(departments) as [DeptKey, typeof departments[DeptKey]][]) {
  if (dept && typeof dept === 'object' && Array.isArray(dept.emails) && dept.emails.includes(userEmail)) {
    userDepartment = key;
    break;
  }
}

const canView = userDepartment === 'management';

// Load report from local file
let report: any = null;
try {
  const reportModule = await import('../../data/reports/pricing-report.json');
  report = reportModule.default || reportModule;
} catch { /* no report yet */ }
---

<AdminLayout title="Pricing Intelligence" userEmail={userEmail}>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Pricing Intelligence</h1>
        <p class="text-gray-600 mt-1">AI-powered market analysis and pricing recommendations</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="/admin/conversions" class="text-sm text-gray-500 hover:text-gray-700">Conversions &rarr;</a>
        <a href="/admin/pricing" class="text-sm text-afj-accent hover:underline">Pricing Config &rarr;</a>
      </div>
    </div>

    {!canView ? (
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-6 text-center">
        <p class="text-amber-800 font-medium">You do not have permission to view pricing intelligence.</p>
        <p class="text-amber-600 text-sm mt-1">Only the Management department can access this page.</p>
      </div>
    ) : !report || !report.generatedAt ? (
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-12 text-center">
        <div class="text-4xl mb-4">&#x1F4CA;</div>
        <h2 class="text-lg font-semibold text-gray-700 mb-2">No Report Yet</h2>
        <p class="text-gray-500 max-w-md mx-auto">The market research agent runs weekly on Sunday at 22:00 UTC. Once enough quotes are collected, it will generate pricing recommendations here.</p>
        <p class="text-xs text-gray-400 mt-4">You can also trigger it manually via GitHub Actions &rarr; Weekly Market Research &rarr; Run workflow</p>
      </div>
    ) : (
      <div>
        <!-- Report Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <div class="flex items-center gap-3">
                <h2 class="text-lg font-semibold text-gray-900">Weekly Report</h2>
                <span class:list={[
                  'px-2 py-0.5 text-xs font-medium rounded-full',
                  report.status === 'pending' ? 'bg-amber-100 text-amber-700' :
                  report.status === 'reviewed' ? 'bg-green-100 text-green-700' :
                  'bg-gray-100 text-gray-600'
                ]}>
                  {report.status === 'pending' ? 'Pending Review' :
                   report.status === 'reviewed' ? 'Reviewed' : report.status}
                </span>
              </div>
              <p class="text-sm text-gray-500 mt-1">
                Period: {report.periodFrom} to {report.periodTo} &middot;
                Generated {new Date(report.generatedAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
              </p>
            </div>
          </div>

          <!-- Key Metrics -->
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-2xl font-bold text-gray-900">{report.quoteCount}</div>
              <div class="text-xs text-gray-500">Quotes</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-2xl font-bold text-gray-900">{report.convertedCount || 0}</div>
              <div class="text-xs text-gray-500">Converted</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-2xl font-bold text-gray-900">{report.conversionRate ? (report.conversionRate * 100).toFixed(0) + '%' : '0%'}</div>
              <div class="text-xs text-gray-500">Conversion Rate</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="text-2xl font-bold text-gray-900">&pound;{report.averageQuoteValue || 0}</div>
              <div class="text-xs text-gray-500">Avg Quote Value</div>
            </div>
          </div>
        </div>

        <!-- AI Insights -->
        {report.insights && (
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
            <h3 class="text-sm font-semibold text-blue-900 mb-2">Market Insights</h3>
            <div class="text-sm text-blue-800 whitespace-pre-line">{report.insights}</div>
          </div>
        )}

        <!-- Recommendations -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">
            Recommendations
            {report.recommendations?.length > 0 && (
              <span class="text-sm font-normal text-gray-500 ml-2">({report.recommendations.length})</span>
            )}
          </h2>

          {(!report.recommendations || report.recommendations.length === 0) ? (
            <p class="text-gray-500 text-sm">No recommendations generated this period. More quote data may be needed.</p>
          ) : (
            <div class="space-y-4" id="recommendationsList">
              {report.recommendations.map((rec: any, idx: number) => (
                <div class="border border-gray-200 rounded-lg p-4 rec-card" data-rec-id={rec.id} data-rec-index={idx}>
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span class:list={[
                        'px-2 py-0.5 text-xs font-semibold rounded-full',
                        rec.priority === 'high' ? 'bg-red-100 text-red-700' :
                        rec.priority === 'medium' ? 'bg-amber-100 text-amber-700' :
                        'bg-gray-100 text-gray-600'
                      ]}>
                        {rec.priority}
                      </span>
                      <span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded-full">{rec.type}</span>
                      {rec.status && (
                        <span class:list={[
                          'px-2 py-0.5 text-xs font-medium rounded-full',
                          rec.status === 'approved' ? 'bg-green-100 text-green-700' :
                          'bg-red-100 text-red-700'
                        ]}>
                          {rec.status}
                        </span>
                      )}
                    </div>
                    {!rec.status && (
                      <div class="flex items-center gap-2">
                        <button type="button" class="test-btn text-xs text-blue-600 hover:text-blue-800 font-medium"
                          data-rec-id={rec.id} data-field={rec.field} data-current={rec.currentValue} data-recommended={rec.recommendedValue}>
                          Test This
                        </button>
                        <button type="button" class="approve-btn text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
                          data-rec-id={rec.id} data-field={rec.field} data-value={rec.recommendedValue}>
                          Approve
                        </button>
                        <button type="button" class="reject-btn text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300"
                          data-rec-id={rec.id}>
                          Reject
                        </button>
                      </div>
                    )}
                  </div>
                  <h3 class="font-semibold text-gray-900">{rec.title}</h3>
                  <p class="text-sm text-gray-600 mt-1">{rec.description}</p>
                  <div class="flex items-center gap-4 mt-2 text-xs text-gray-500">
                    {rec.currentValue != null && (
                      <span>Current: <strong class="text-gray-700">{rec.currentValue}</strong></span>
                    )}
                    {rec.recommendedValue != null && (
                      <span>Recommended: <strong class="text-afj-green">{rec.recommendedValue}</strong></span>
                    )}
                    {rec.estimatedImpact && (
                      <span>Impact: {rec.estimatedImpact}</span>
                    )}
                  </div>
                  {rec.reasoning && (
                    <p class="text-xs text-gray-400 mt-2 italic">{rec.reasoning}</p>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>

        <!-- Test This Panel -->
        <div id="testPanel" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6 hidden">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Test Quote Comparison</h2>
            <button type="button" id="closeTestPanel" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
          </div>
          <p class="text-sm text-gray-500 mb-4" id="testDescription">Comparing current vs recommended pricing across 5 standard journeys</p>

          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-gray-200">
                  <th class="text-left py-2 pr-4 text-gray-500 font-medium">Journey</th>
                  <th class="text-right py-2 px-3 text-gray-500 font-medium">Current</th>
                  <th class="text-right py-2 px-3 text-gray-500 font-medium">Recommended</th>
                  <th class="text-right py-2 pl-3 text-gray-500 font-medium">Diff</th>
                </tr>
              </thead>
              <tbody id="testTableBody">
                <tr><td colspan="4" class="py-4 text-center text-gray-400">Click "Test This" on a recommendation...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tier Analysis -->
        {report.tierAnalysis && Object.keys(report.tierAnalysis).length > 0 && (
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Tier Analysis</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
              {Object.entries(report.tierAnalysis).map(([band, data]: [string, any]) => (
                <div class="bg-gray-50 rounded-lg p-3">
                  <div class="text-sm font-semibold text-gray-700 mb-1">{band} pax</div>
                  <div class="text-xs text-gray-500">
                    <div>Quotes: {data.quoteCount || 0}</div>
                    <div>Avg: &pound;{data.avgValue || 0}</div>
                    <div>Conv: {data.conversionRate ? (data.conversionRate * 100).toFixed(0) + '%' : 'N/A'}</div>
                  </div>
                  {data.assessment && <p class="text-xs text-gray-400 mt-1">{data.assessment}</p>}
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Minimum Floor Analysis -->
        {report.minimumFloorAnalysis && (
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Minimum Floor Analysis</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {Object.entries(report.minimumFloorAnalysis).map(([service, data]: [string, any]) => (
                <div class="bg-gray-50 rounded-lg p-4">
                  <h3 class="text-sm font-semibold text-gray-700 mb-1 capitalize">{service.replace('-', ' ')}</h3>
                  {data.assessment && <p class="text-sm text-gray-600">{data.assessment}</p>}
                  {data.recommendation && <p class="text-xs text-afj-accent mt-1">{data.recommendation}</p>}
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Top Routes -->
        {report.topRoutes && report.topRoutes.length > 0 && (
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Top Routes</h2>
            <div class="space-y-2">
              {report.topRoutes.slice(0, 5).map((r: any) => (
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-700 font-mono">{r.route}</span>
                  <span class="text-gray-500">{r.count} quotes</span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    )}
  </div>

  <script is:inline>
    // Standard test journeys for the "Test This" panel
    var testJourneys = [
      { name: 'Birmingham \u2192 Manchester (5-8 pax)', pickup: 'B7 4QS', dest: 'M1 1AD', pax: '5-8', date: null, time: '09:00' },
      { name: 'Birmingham \u2192 Coventry (1-4 pax)', pickup: 'B7 4QS', dest: 'CV1 1FL', pax: '1-4', date: null, time: '10:00' },
      { name: 'Birmingham \u2192 London (9-16 pax)', pickup: 'B7 4QS', dest: 'WC1A 1AA', pax: '9-16', date: null, time: '08:00' },
      { name: 'Wolverhampton \u2192 Birmingham (17-24 pax)', pickup: 'WV1 1AA', dest: 'B7 4QS', pax: '17-24', date: null, time: '14:00' },
      { name: 'Manchester \u2192 Leeds (34-48 pax)', pickup: 'M1 1AD', dest: 'LS1 1BA', pax: '34-48', date: null, time: '11:00' },
    ];

    // Set dates to tomorrow for each test journey
    var tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    var dateStr = tomorrow.toISOString().split('T')[0];
    testJourneys.forEach(function (j) { j.date = dateStr; });

    // Fetch a quote estimate
    function fetchQuote(pickup, dest, pax, date, time) {
      return fetch('/api/quote/estimate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          service: 'private-hire',
          answers: {
            pickupPostcode: pickup,
            destinationPostcode: dest,
            passengers: pax,
            date: date,
            time: time,
          },
        }),
      }).then(function (r) { return r.json(); });
    }

    // "Test This" buttons
    document.querySelectorAll('.test-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var panel = document.getElementById('testPanel');
        var tbody = document.getElementById('testTableBody');
        var desc = document.getElementById('testDescription');
        var field = btn.dataset.field;
        var current = btn.dataset.current;
        var recommended = btn.dataset.recommended;

        panel.classList.remove('hidden');
        desc.textContent = 'Testing: ' + field + ' \u2014 current ' + current + ' vs recommended ' + recommended;
        tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Running 5 test quotes...</td></tr>';

        // Fetch current quotes for all test journeys
        var promises = testJourneys.map(function (j) {
          return fetchQuote(j.pickup, j.dest, j.pax, j.date, j.time);
        });

        Promise.all(promises).then(function (results) {
          var html = '';
          results.forEach(function (res, i) {
            var j = testJourneys[i];
            if (res.success) {
              var est = res.estimate;
              // Simple scaling for recommended value comparison
              var ratio = 1;
              if (field === 'costPerMile' || field === 'chargeOutRatePerHour') {
                ratio = parseFloat(recommended) / parseFloat(current);
              }
              var recLow = Math.round(est.low * ratio);
              var recHigh = Math.round(est.high * ratio);
              var diff = recLow - est.low;
              var diffClass = diff > 0 ? 'text-green-600' : diff < 0 ? 'text-red-600' : 'text-gray-500';

              html += '<tr class="border-b border-gray-100">'
                + '<td class="py-2 pr-4 text-gray-700">' + j.name + '</td>'
                + '<td class="py-2 px-3 text-right text-gray-500">\u00A3' + est.low + ' \u2013 \u00A3' + est.high + '</td>'
                + '<td class="py-2 px-3 text-right font-semibold text-afj-green">\u00A3' + recLow + ' \u2013 \u00A3' + recHigh + '</td>'
                + '<td class="py-2 pl-3 text-right ' + diffClass + '">' + (diff >= 0 ? '+' : '') + '\u00A3' + diff + '</td>'
                + '</tr>';
            } else {
              html += '<tr class="border-b border-gray-100"><td class="py-2 pr-4">' + j.name + '</td><td colspan="3" class="py-2 text-center text-red-500 text-xs">Error</td></tr>';
            }
          });
          tbody.innerHTML = html;
        }).catch(function () {
          tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-red-500">Failed to fetch test quotes</td></tr>';
        });
      });
    });

    // Close test panel
    var closeBtn = document.getElementById('closeTestPanel');
    if (closeBtn) {
      closeBtn.addEventListener('click', function () {
        document.getElementById('testPanel').classList.add('hidden');
      });
    }

    // Approve buttons
    document.querySelectorAll('.approve-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var recId = btn.dataset.recId;
        if (!confirm('Apply this recommendation? This will update the pricing configuration.')) return;

        btn.disabled = true;
        btn.textContent = 'Applying...';

        // First, update the report status
        fetch('/api/admin/pricing-report', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recommendationId: recId, action: 'approve' }),
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.success) {
              var card = btn.closest('.rec-card');
              if (card) {
                var btns = card.querySelectorAll('.approve-btn, .reject-btn, .test-btn');
                btns.forEach(function (b) { b.remove(); });
                var badge = document.createElement('span');
                badge.className = 'px-2 py-0.5 text-xs font-medium rounded-full bg-green-100 text-green-700';
                badge.textContent = 'approved';
                card.querySelector('.flex').appendChild(badge);
              }
            } else {
              alert('Failed: ' + (data.error || 'Unknown error'));
              btn.disabled = false;
              btn.textContent = 'Approve';
            }
          })
          .catch(function () {
            alert('Failed to apply recommendation');
            btn.disabled = false;
            btn.textContent = 'Approve';
          });
      });
    });

    // Reject buttons
    document.querySelectorAll('.reject-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var recId = btn.dataset.recId;
        var reason = prompt('Optional: Why are you rejecting this recommendation?');
        if (reason === null) return; // cancelled

        btn.disabled = true;
        btn.textContent = 'Rejecting...';

        fetch('/api/admin/pricing-report', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recommendationId: recId, action: 'reject', reason: reason || undefined }),
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.success) {
              var card = btn.closest('.rec-card');
              if (card) {
                var btns = card.querySelectorAll('.approve-btn, .reject-btn, .test-btn');
                btns.forEach(function (b) { b.remove(); });
                var badge = document.createElement('span');
                badge.className = 'px-2 py-0.5 text-xs font-medium rounded-full bg-red-100 text-red-700';
                badge.textContent = 'rejected';
                card.querySelector('.flex').appendChild(badge);
              }
            } else {
              alert('Failed: ' + (data.error || 'Unknown error'));
              btn.disabled = false;
              btn.textContent = 'Reject';
            }
          })
          .catch(function () {
            alert('Failed to reject recommendation');
            btn.disabled = false;
            btn.textContent = 'Reject';
          });
      });
    });
  </script>
</AdminLayout>
