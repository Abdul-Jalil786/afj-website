---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import departments from '../../data/departments.json';

const userEmail = Astro.request.headers.get('Cf-Access-Authenticated-User-Email') || 'admin@afjltd.co.uk';

// Determine permissions
type DeptKey = keyof typeof departments;
let canApprove = true;
let departmentName = 'Management';

for (const [key, dept] of Object.entries(departments) as [DeptKey, typeof departments[DeptKey]][]) {
  if (dept.emails.includes(userEmail)) {
    canApprove = dept.canApprove;
    departmentName = dept.name;
    break;
  }
}
---

<AdminLayout title="Approvals" userEmail={userEmail}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">
        {canApprove ? 'Content Approvals' : 'My Submissions'}
      </h1>
      <p class="text-gray-600 mt-1">
        {canApprove
          ? 'Review and approve pending blog posts and page changes.'
          : 'Track the status of content you have submitted for approval.'}
      </p>
    </div>

    <!-- Pending Items Container -->
    <div id="pendingItems">
      <!-- Empty State -->
      <div id="emptyState" class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-1">No pending items</h3>
        <p class="text-gray-500 text-sm">
          {canApprove
            ? 'All content has been reviewed. New submissions will appear here.'
            : 'You have no pending submissions. Create a blog post or update a page to get started.'}
        </p>
        <div class="mt-6 flex justify-center gap-4">
          <a href="/admin/content" class="btn-primary text-sm">Create Blog Post</a>
          <a href="/admin/pages" class="btn-outline text-sm">Update a Page</a>
        </div>
      </div>
    </div>

    <!-- Approval Item Template (hidden, used by JS for future dynamic items) -->
    <template id="approvalCardTemplate">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4">
        <div class="flex items-start justify-between">
          <div>
            <span class="inline-block px-2 py-0.5 text-xs font-medium rounded-full bg-amber-100 text-amber-700 mb-2">Pending</span>
            <h3 class="text-lg font-semibold text-gray-900 item-title"></h3>
            <div class="flex items-center gap-4 mt-2 text-sm text-gray-500">
              <span class="item-author"></span>
              <span class="item-department"></span>
              <span class="item-date"></span>
            </div>
          </div>
          <div class="flex gap-2">
            <button class="approve-btn bg-afj-accent text-white text-sm font-medium px-4 py-2 rounded-md hover:bg-afj-green transition-colors" style="display: none;">
              Approve
            </button>
            <button class="reject-btn bg-red-500 text-white text-sm font-medium px-4 py-2 rounded-md hover:bg-red-600 transition-colors" style="display: none;">
              Reject
            </button>
          </div>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-100">
          <a href="#" class="text-afj-accent text-sm font-medium hover:underline preview-link">Preview content</a>
        </div>
      </div>
    </template>

    {canApprove && (
      <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-blue-900">Approval Workflow</h3>
        <p class="text-sm text-blue-700 mt-1">
          When team members submit blog posts or page changes, they will appear here for your review.
          You can preview the content, then approve to publish or reject with feedback.
          Approved content is automatically committed to GitHub and deployed via Railway.
        </p>
      </div>
    )}
  </div>
</AdminLayout>
