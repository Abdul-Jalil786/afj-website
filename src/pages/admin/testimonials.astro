---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import departments from '../../data/departments.json';

const userEmail = Astro.request.headers.get('Cf-Access-Authenticated-User-Email') || 'unknown';

// Determine permissions
type DeptKey = keyof typeof departments;
let canApprove = true;
let departmentName = 'Management';

for (const [key, dept] of Object.entries(departments) as [DeptKey, typeof departments[DeptKey]][]) {
  if (dept.emails.includes(userEmail)) {
    canApprove = dept.canApprove;
    departmentName = dept.name;
    break;
  }
}

const serviceCategories = [
  'SEND Transport',
  'Patient Transport (NEPTS)',
  'Fleet Maintenance',
  'Vehicle Conversions',
  'Professional Driver Training',
  'Private Hire',
  'Executive Minibus',
  'Airport Transfers',
];
---

<AdminLayout title="Testimonials & Case Studies" userEmail={userEmail}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">Testimonials & Case Studies</h1>
      <p class="text-gray-600 mt-1">Paste raw customer feedback and let AI generate a polished testimonial and case study.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Left: Input Form -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Customer Feedback</h2>

        <div class="space-y-4">
          <div>
            <label for="rawFeedback" class="block text-sm font-medium text-gray-700 mb-1">Raw Feedback</label>
            <textarea
              id="rawFeedback"
              rows="8"
              placeholder="Paste the customer's raw feedback, email, or verbal comments here...&#10;&#10;Example: 'We've been using AFJ for our school transport for 3 years now. The drivers are always punctual and the children feel safe. Our SENCO particularly appreciates the care taken with wheelchair users.'"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-afj-accent focus:border-afj-accent text-sm"
            ></textarea>
          </div>

          <div>
            <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Client Name / Role (optional)</label>
            <input
              type="text"
              id="clientName"
              placeholder="e.g., Sarah Johnson, SENCO at Wilson Stuart School"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-afj-accent focus:border-afj-accent text-sm"
            />
          </div>

          <div>
            <label for="serviceCategory" class="block text-sm font-medium text-gray-700 mb-1">Service Category</label>
            <select id="serviceCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-afj-accent focus:border-afj-accent text-sm">
              <option value="">Select a category...</option>
              {serviceCategories.map((cat) => (
                <option value={cat}>{cat}</option>
              ))}
            </select>
          </div>

          <button
            id="generateBtn"
            class="w-full bg-afj-accent text-white font-semibold py-3 px-6 rounded-lg hover:bg-afj-green transition-colors"
          >
            Generate Testimonial & Case Study
          </button>

          <!-- Status Message -->
          <div id="statusMsg" class="hidden text-sm text-center py-2 rounded-md"></div>
        </div>
      </div>

      <!-- Right: Preview Panel -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-900">AI Output</h2>
          <div class="flex gap-2">
            <button id="editToggleBtn" class="hidden text-sm px-3 py-1.5 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
              Edit
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden flex flex-col items-center justify-center py-16 text-gray-500">
          <svg class="animate-spin h-8 w-8 text-afj-accent mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="text-sm">Generating testimonial and case study...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="flex flex-col items-center justify-center py-16 text-gray-400">
          <svg class="w-12 h-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          </svg>
          <p class="text-sm">Your AI-generated content will appear here</p>
        </div>

        <!-- Preview Content -->
        <div id="previewContent" class="hidden prose prose-sm max-w-none"></div>

        <!-- Edit Mode -->
        <textarea
          id="editArea"
          class="hidden w-full h-96 px-3 py-2 border border-gray-300 rounded-md font-mono text-xs focus:ring-2 focus:ring-afj-accent focus:border-afj-accent"
        ></textarea>

        <!-- Action Buttons -->
        <div id="actionButtons" class="hidden mt-6 flex flex-col sm:flex-row gap-3">
          {canApprove ? (
            <button id="publishTestimonialBtn" class="flex-1 bg-afj-accent text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-afj-green transition-colors text-sm">
              Save Testimonial
            </button>
          ) : (
            <button id="submitApprovalBtn" class="flex-1 bg-amber-500 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-amber-600 transition-colors text-sm">
              Submit for Approval
            </button>
          )}
          <button id="publishBlogBtn" class="flex-1 border border-afj-accent text-afj-accent font-medium py-2.5 px-4 rounded-lg hover:bg-afj-accent/5 transition-colors text-sm">
            Publish as Blog Post
          </button>
          <button id="regenerateBtn" class="flex-1 border border-gray-300 text-gray-700 font-medium py-2.5 px-4 rounded-lg hover:bg-gray-50 transition-colors text-sm">
            Regenerate
          </button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    const rawFeedbackInput = document.getElementById('rawFeedback');
    const clientNameInput = document.getElementById('clientName');
    const serviceCategorySelect = document.getElementById('serviceCategory');
    const generateBtn = document.getElementById('generateBtn');
    const regenerateBtn = document.getElementById('regenerateBtn');
    const editToggleBtn = document.getElementById('editToggleBtn');
    const publishTestimonialBtn = document.getElementById('publishTestimonialBtn');
    const submitApprovalBtn = document.getElementById('submitApprovalBtn');
    const publishBlogBtn = document.getElementById('publishBlogBtn');
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const previewContent = document.getElementById('previewContent');
    const editArea = document.getElementById('editArea');
    const actionButtons = document.getElementById('actionButtons');
    const statusMsg = document.getElementById('statusMsg');

    let currentResult = '';
    let isEditMode = false;

    function showStatus(message, isError) {
      statusMsg.textContent = message;
      statusMsg.className = 'text-sm text-center py-2 rounded-md ' + (isError ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700');
      statusMsg.classList.remove('hidden');
      setTimeout(() => statusMsg.classList.add('hidden'), 5000);
    }

    function renderMarkdown(md) {
      let html = md
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^\- (.*$)/gm, '<li>$1</li>')
        .replace(/\n\n/g, '</p><p>');
      if (!html.startsWith('<')) html = '<p>' + html + '</p>';
      return html;
    }

    async function generateTestimonial() {
      const rawFeedback = rawFeedbackInput.value.trim();
      const clientName = clientNameInput.value.trim();
      const serviceCategory = serviceCategorySelect.value;

      if (!rawFeedback) {
        showStatus('Please paste the customer feedback.', true);
        return;
      }

      emptyState.classList.add('hidden');
      previewContent.classList.add('hidden');
      editArea.classList.add('hidden');
      actionButtons.classList.add('hidden');
      editToggleBtn.classList.add('hidden');
      loadingState.classList.remove('hidden');
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';

      try {
        const res = await fetch('/api/ai/testimonial', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rawFeedback, clientName, serviceCategory }),
        });

        const data = await res.json();

        if (data.success && data.result) {
          currentResult = data.result;
          previewContent.innerHTML = renderMarkdown(data.result);
          editArea.value = data.result;

          loadingState.classList.add('hidden');
          previewContent.classList.remove('hidden');
          actionButtons.classList.remove('hidden');
          editToggleBtn.classList.remove('hidden');
          showStatus('Testimonial and case study generated.', false);
        } else {
          throw new Error(data.error || 'Failed to generate');
        }
      } catch (err) {
        loadingState.classList.add('hidden');
        emptyState.classList.remove('hidden');
        showStatus(err.message || 'AI generation is temporarily unavailable.', true);
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Testimonial & Case Study';
      }
    }

    function toggleEdit() {
      isEditMode = !isEditMode;
      if (isEditMode) {
        editArea.value = currentResult;
        previewContent.classList.add('hidden');
        editArea.classList.remove('hidden');
        editToggleBtn.textContent = 'Preview';
      } else {
        currentResult = editArea.value;
        previewContent.innerHTML = renderMarkdown(currentResult);
        editArea.classList.add('hidden');
        previewContent.classList.remove('hidden');
        editToggleBtn.textContent = 'Edit';
      }
    }

    // Extract the short testimonial from the AI output
    function extractShortTestimonial(text) {
      const match = text.match(/## SHORT TESTIMONIAL\s*\n([\s\S]*?)(?=\n## CASE STUDY|$)/);
      if (match) return match[1].trim();
      return text.split('\n')[0] || '';
    }

    async function saveTestimonial() {
      if (!currentResult) return;
      const btn = publishTestimonialBtn;
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Saving...';
      }

      try {
        const shortQuote = extractShortTestimonial(currentResult);
        const clientName = clientNameInput.value.trim() || 'AFJ Customer';
        const serviceCategory = serviceCategorySelect.value || 'General';

        const testimonialEntry = {
          quote: shortQuote,
          name: clientName,
          service: serviceCategory,
          date: new Date().toISOString().split('T')[0],
          fullCaseStudy: currentResult,
        };

        const res = await fetch('/api/admin/approval', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'testimonial',
            title: 'Testimonial: ' + clientName,
            content: JSON.stringify(testimonialEntry, null, 2),
            metadata: { clientName, serviceCategory },
          }),
        });

        const data = await res.json();

        if (data.success) {
          showStatus('Testimonial saved successfully.', false);
        } else {
          throw new Error(data.error || 'Failed to save');
        }
      } catch (err) {
        showStatus(err.message || 'Failed to save testimonial.', true);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Save Testimonial';
        }
      }
    }

    async function publishAsBlog() {
      if (!currentResult) return;
      if (publishBlogBtn) {
        publishBlogBtn.disabled = true;
        publishBlogBtn.textContent = 'Publishing...';
      }

      try {
        const clientName = clientNameInput.value.trim() || 'AFJ Customer';
        const serviceCategory = serviceCategorySelect.value || 'Transport Services';

        // Extract the case study section for the blog post body
        const caseStudyMatch = currentResult.match(/## CASE STUDY\s*\n([\s\S]*?)$/);
        const caseStudyBody = caseStudyMatch ? caseStudyMatch[1].trim() : currentResult;

        const title = `Case Study: ${clientName} â€” ${serviceCategory}`;
        const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        const pubDate = new Date().toISOString().split('T')[0];

        const res = await fetch('/api/blog/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            slug,
            description: `Read how AFJ Limited helped ${clientName} with ${serviceCategory.toLowerCase()} services.`,
            pubDate,
            image: '/images/blog/case-study.webp',
            imageAlt: `${clientName} case study`,
            tags: [serviceCategory, 'Case Study', 'Testimonial'],
            body: caseStudyBody,
          }),
        });

        const data = await res.json();

        if (data.success) {
          showStatus('Case study published as blog post.', false);
        } else {
          throw new Error(data.error || 'Failed to publish');
        }
      } catch (err) {
        showStatus(err.message || 'Failed to publish blog post.', true);
      } finally {
        if (publishBlogBtn) {
          publishBlogBtn.disabled = false;
          publishBlogBtn.textContent = 'Publish as Blog Post';
        }
      }
    }

    async function submitForApproval() {
      if (!currentResult) return;
      if (submitApprovalBtn) {
        submitApprovalBtn.disabled = true;
        submitApprovalBtn.textContent = 'Submitting...';
      }

      try {
        const clientName = clientNameInput.value.trim() || 'AFJ Customer';
        const serviceCategory = serviceCategorySelect.value || 'General';

        const res = await fetch('/api/admin/approval', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'testimonial',
            title: 'Testimonial: ' + clientName,
            content: currentResult,
            metadata: { clientName, serviceCategory },
          }),
        });

        const data = await res.json();

        if (data.success) {
          showStatus('Submitted for approval. You\'ll be notified when it\'s published.', false);
        } else {
          throw new Error(data.error || 'Failed to submit');
        }
      } catch (err) {
        showStatus(err.message || 'Failed to submit for approval.', true);
      } finally {
        if (submitApprovalBtn) {
          submitApprovalBtn.disabled = false;
          submitApprovalBtn.textContent = 'Submit for Approval';
        }
      }
    }

    generateBtn.addEventListener('click', generateTestimonial);
    regenerateBtn && regenerateBtn.addEventListener('click', generateTestimonial);
    editToggleBtn.addEventListener('click', toggleEdit);
    publishTestimonialBtn && publishTestimonialBtn.addEventListener('click', saveTestimonial);
    submitApprovalBtn && submitApprovalBtn.addEventListener('click', submitForApproval);
    publishBlogBtn && publishBlogBtn.addEventListener('click', publishAsBlog);
  </script>
</AdminLayout>
