---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import departments from '../../data/departments.json';
import { authenticateRequest } from '../../lib/cf-auth';

const userEmail = await authenticateRequest(Astro.request);
if (!userEmail) {
  return new Response('<h1>Access Denied</h1><p>You must be authenticated via Cloudflare Zero Trust to access the admin dashboard.</p><p><a href="/">Return to website</a></p>', { status: 403, headers: { 'Content-Type': 'text/html' } });
}

type DeptKey = keyof typeof departments;
let userDepartment: DeptKey = 'management';

for (const [key, dept] of Object.entries(departments) as [DeptKey, typeof departments[DeptKey]][]) {
  if (dept && typeof dept === 'object' && Array.isArray(dept.emails) && dept.emails.includes(userEmail)) {
    userDepartment = key;
    break;
  }
}

const canView = userDepartment === 'management' || userDepartment === 'marketing';
---

<AdminLayout title="Social Media" userEmail={userEmail}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Social Media</h1>
        <p class="text-gray-600 mt-1">AI-generated social posts. Drafts are auto-created when blog posts are published.</p>
      </div>
    </div>

    {!canView ? (
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-6 text-center">
        <p class="text-amber-800 font-medium">You do not have permission to manage social media.</p>
        <p class="text-amber-600 text-sm mt-1">Only Management and Marketing departments can access this page.</p>
      </div>
    ) : (
      <div>
        <!-- Create New Post -->
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Create New Post</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
              <select id="newPlatform" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                <option value="linkedin">LinkedIn</option>
                <option value="facebook">Facebook</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Topic *</label>
              <input id="newTopic" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="e.g. SEND transport services in Birmingham" />
            </div>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Brief (optional)</label>
            <textarea id="newBrief" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" rows="2" placeholder="Any specific points to include..."></textarea>
          </div>
          <button id="generateBtn" class="mt-4 bg-afj-accent text-white font-semibold py-2.5 px-6 rounded-lg hover:bg-afj-green transition-colors">
            Generate with AI
          </button>
        </div>

        <!-- Filter Bar -->
        <div class="flex flex-wrap gap-3 mb-4">
          <select id="filterPlatform" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">All platforms</option>
            <option value="linkedin">LinkedIn</option>
            <option value="facebook">Facebook</option>
          </select>
          <select id="filterStatus" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">All statuses</option>
            <option value="draft" selected>Drafts</option>
            <option value="approved">Approved</option>
            <option value="published">Published</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>

        <!-- Drafts List -->
        <div id="draftsList" class="space-y-4">
          <div class="bg-white rounded-lg border border-gray-200 p-8 text-center text-gray-400">Loading...</div>
        </div>

        <!-- Draft Detail Modal -->
        <div id="draftModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
          <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span id="dmPlatformBadge" class="px-2 py-0.5 rounded-full text-xs font-medium"></span>
                <span id="dmStatusBadge" class="px-2 py-0.5 rounded-full text-xs font-medium"></span>
              </div>
              <button id="dmClose" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
            <div class="p-6">
              <div id="dmBlogInfo" class="hidden mb-4 text-sm text-gray-500"></div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Post Content</label>
                <textarea id="dmContent" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" rows="8"></textarea>
              </div>
              <div id="dmRewriteSection" class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">AI Rewrite Instruction</label>
                <div class="flex gap-2">
                  <input id="dmRewriteInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="e.g. Make it more engaging, add a question at the start" />
                  <button id="dmRewriteBtn" class="bg-blue-600 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors whitespace-nowrap">Rewrite</button>
                </div>
              </div>
              <div id="dmActions" class="flex flex-wrap gap-3">
                <button id="dmSaveBtn" class="bg-gray-600 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">Save Edit</button>
                <button id="dmApproveBtn" class="bg-green-600 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">Approve</button>
                <button id="dmPublishBtn" class="bg-afj-accent text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-afj-green transition-colors">Publish to Platform</button>
                <button id="dmRejectBtn" class="bg-red-600 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">Reject</button>
                <button id="dmDeleteBtn" class="text-red-500 hover:text-red-700 text-sm font-medium px-4 py-2">Delete</button>
              </div>
              <div id="dmPublishResult" class="hidden mt-4 text-sm"></div>
            </div>
          </div>
        </div>
      </div>
    )}
  </div>

  <script is:inline>
    (function() {
      var PLATFORM_BADGES = {
        linkedin: { class: 'bg-blue-100 text-blue-700', label: 'LinkedIn' },
        facebook: { class: 'bg-indigo-100 text-indigo-700', label: 'Facebook' },
      };
      var STATUS_BADGES = {
        draft: { class: 'bg-gray-100 text-gray-600', label: 'Draft' },
        approved: { class: 'bg-green-100 text-green-700', label: 'Approved' },
        published: { class: 'bg-afj-accent/10 text-afj-accent', label: 'Published' },
        rejected: { class: 'bg-red-100 text-red-700', label: 'Rejected' },
      };

      var currentDraftId = null;
      var currentDraft = null;

      function loadDrafts() {
        var params = new URLSearchParams();
        var platform = document.getElementById('filterPlatform').value;
        var status = document.getElementById('filterStatus').value;
        if (platform) params.set('platform', platform);
        if (status) params.set('status', status);

        fetch('/api/admin/social?' + params.toString())
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (!data.success) return;
            renderDrafts(data.data);
          })
          .catch(function() {
            document.getElementById('draftsList').innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center text-red-700">Failed to load drafts</div>';
          });
      }

      function renderDrafts(drafts) {
        var list = document.getElementById('draftsList');
        if (drafts.length === 0) {
          list.innerHTML = '<div class="bg-white rounded-lg border border-gray-200 p-8 text-center text-gray-400">No social media drafts matching filters.</div>';
          return;
        }

        list.innerHTML = drafts.map(function(d) {
          var pb = PLATFORM_BADGES[d.platform] || PLATFORM_BADGES.linkedin;
          var sb = STATUS_BADGES[d.status] || STATUS_BADGES.draft;
          var preview = (d.editedContent || d.content).slice(0, 150) + ((d.editedContent || d.content).length > 150 ? '...' : '');
          var blogLabel = d.blogTitle ? '<span class="text-xs text-gray-400">Blog: ' + d.blogTitle + '</span>' : '';

          return '<div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-sm transition-shadow cursor-pointer draft-row" data-draft-id="' + d.id + '">'
            + '<div class="flex items-start justify-between">'
            + '<div class="min-w-0 flex-1">'
            + '<div class="flex items-center gap-2 flex-wrap mb-1">'
            + '<span class="px-2 py-0.5 rounded-full text-xs font-medium ' + pb.class + '">' + pb.label + '</span>'
            + '<span class="px-2 py-0.5 rounded-full text-xs font-medium ' + sb.class + '">' + sb.label + '</span>'
            + blogLabel
            + '</div>'
            + '<p class="text-sm text-gray-700">' + preview + '</p>'
            + '<p class="text-xs text-gray-400 mt-1">' + new Date(d.createdAt).toLocaleDateString('en-GB') + '</p>'
            + '</div>'
            + '<svg class="w-5 h-5 text-gray-400 flex-shrink-0 ml-3 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>'
            + '</div></div>';
        }).join('');
      }

      // Open draft detail
      document.getElementById('draftsList').addEventListener('click', function(e) {
        var row = e.target.closest('.draft-row');
        if (!row) return;
        var draftId = row.getAttribute('data-draft-id');

        fetch('/api/admin/social?id=' + draftId)
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (!data.success) return;
            openDraftModal(data.data);
          });
      });

      function openDraftModal(draft) {
        currentDraftId = draft.id;
        currentDraft = draft;

        var pb = PLATFORM_BADGES[draft.platform] || PLATFORM_BADGES.linkedin;
        var sb = STATUS_BADGES[draft.status] || STATUS_BADGES.draft;

        document.getElementById('dmPlatformBadge').className = 'px-2 py-0.5 rounded-full text-xs font-medium ' + pb.class;
        document.getElementById('dmPlatformBadge').textContent = pb.label;
        document.getElementById('dmStatusBadge').className = 'px-2 py-0.5 rounded-full text-xs font-medium ' + sb.class;
        document.getElementById('dmStatusBadge').textContent = sb.label;

        var blogInfo = document.getElementById('dmBlogInfo');
        if (draft.blogTitle) {
          blogInfo.classList.remove('hidden');
          blogInfo.innerHTML = 'For blog: <a href="/blog/' + draft.blogSlug + '" class="text-afj-accent hover:underline" target="_blank">' + draft.blogTitle + '</a>';
        } else {
          blogInfo.classList.add('hidden');
        }

        document.getElementById('dmContent').value = draft.editedContent || draft.content;

        // Show/hide buttons based on status
        var canEdit = draft.status === 'draft' || draft.status === 'approved';
        document.getElementById('dmRewriteSection').style.display = canEdit ? '' : 'none';
        document.getElementById('dmSaveBtn').style.display = canEdit ? '' : 'none';
        document.getElementById('dmApproveBtn').style.display = draft.status === 'draft' ? '' : 'none';
        document.getElementById('dmPublishBtn').style.display = draft.status === 'approved' ? '' : 'none';
        document.getElementById('dmRejectBtn').style.display = (draft.status === 'draft' || draft.status === 'approved') ? '' : 'none';
        document.getElementById('dmPublishResult').classList.add('hidden');

        document.getElementById('draftModal').classList.remove('hidden');
      }

      // Close modal
      document.getElementById('dmClose').addEventListener('click', function() {
        document.getElementById('draftModal').classList.add('hidden');
      });
      document.getElementById('draftModal').addEventListener('click', function(e) {
        if (e.target === this) this.classList.add('hidden');
      });

      // Save edit
      document.getElementById('dmSaveBtn').addEventListener('click', function() {
        if (!currentDraftId) return;
        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        fetch('/api/admin/social', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: currentDraftId, action: 'edit', editedContent: document.getElementById('dmContent').value }),
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success) { loadDrafts(); }
        })
        .finally(function() { btn.disabled = false; btn.textContent = 'Save Edit'; });
      });

      // Approve
      document.getElementById('dmApproveBtn').addEventListener('click', function() {
        if (!currentDraftId) return;
        fetch('/api/admin/social', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: currentDraftId, action: 'approve' }),
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success) {
            document.getElementById('draftModal').classList.add('hidden');
            loadDrafts();
          }
        });
      });

      // Reject
      document.getElementById('dmRejectBtn').addEventListener('click', function() {
        if (!currentDraftId) return;
        fetch('/api/admin/social', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: currentDraftId, action: 'reject' }),
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success) {
            document.getElementById('draftModal').classList.add('hidden');
            loadDrafts();
          }
        });
      });

      // Delete
      document.getElementById('dmDeleteBtn').addEventListener('click', function() {
        if (!currentDraftId || !confirm('Delete this draft?')) return;
        fetch('/api/admin/social', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: currentDraftId, action: 'delete' }),
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success) {
            document.getElementById('draftModal').classList.add('hidden');
            loadDrafts();
          }
        });
      });

      // AI Rewrite
      document.getElementById('dmRewriteBtn').addEventListener('click', function() {
        if (!currentDraftId) return;
        var instruction = document.getElementById('dmRewriteInput').value.trim();
        if (!instruction) { alert('Enter a rewrite instruction'); return; }

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Rewriting...';

        fetch('/api/admin/social', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'rewrite', id: currentDraftId, instruction: instruction }),
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success) {
            document.getElementById('dmContent').value = data.data.newContent;
            document.getElementById('dmRewriteInput').value = '';
          } else {
            alert(data.error || 'Rewrite failed');
          }
        })
        .catch(function() { alert('Request failed'); })
        .finally(function() { btn.disabled = false; btn.textContent = 'Rewrite'; });
      });

      // Publish to platform
      document.getElementById('dmPublishBtn').addEventListener('click', function() {
        if (!currentDraft) return;
        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Publishing...';

        var endpoint = currentDraft.platform === 'linkedin'
          ? '/api/admin/social/publish-linkedin'
          : '/api/admin/social/publish-facebook';

        fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: currentDraftId }),
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var result = document.getElementById('dmPublishResult');
          result.classList.remove('hidden');
          if (data.success) {
            result.className = 'mt-4 text-sm text-green-600';
            result.textContent = data.data.message;
            setTimeout(function() {
              document.getElementById('draftModal').classList.add('hidden');
              loadDrafts();
            }, 1500);
          } else if (data.setup) {
            result.className = 'mt-4 text-sm text-amber-600';
            result.innerHTML = '<strong>' + data.setup.message + '</strong><ul class="mt-1 list-disc list-inside">'
              + data.setup.variables.map(function(v) { return '<li>' + v + '</li>'; }).join('')
              + '</ul>'
              + '<p class="mt-2">For now, copy the post text and publish manually. Use "Save Edit" to mark any changes.</p>';
            // Mark as published manually
            fetch('/api/admin/social', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: currentDraftId, action: 'mark-published' }),
            }).then(function() { loadDrafts(); });
          } else {
            result.className = 'mt-4 text-sm text-red-600';
            result.textContent = data.error || 'Publish failed';
          }
        })
        .catch(function() {
          document.getElementById('dmPublishResult').className = 'mt-4 text-sm text-red-600';
          document.getElementById('dmPublishResult').classList.remove('hidden');
          document.getElementById('dmPublishResult').textContent = 'Request failed';
        })
        .finally(function() { btn.disabled = false; btn.textContent = 'Publish to Platform'; });
      });

      // Generate new post
      document.getElementById('generateBtn').addEventListener('click', function() {
        var topic = document.getElementById('newTopic').value.trim();
        if (!topic) { alert('Enter a topic'); return; }

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Generating...';

        fetch('/api/admin/social', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'generate',
            platform: document.getElementById('newPlatform').value,
            topic: topic,
            brief: document.getElementById('newBrief').value.trim(),
          }),
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success) {
            document.getElementById('newTopic').value = '';
            document.getElementById('newBrief').value = '';
            document.getElementById('filterStatus').value = 'draft';
            loadDrafts();
            openDraftModal(data.data);
          } else {
            alert(data.error || 'Generation failed');
          }
        })
        .catch(function() { alert('Request failed'); })
        .finally(function() { btn.disabled = false; btn.textContent = 'Generate with AI'; });
      });

      // Filter handlers
      document.getElementById('filterPlatform').addEventListener('change', loadDrafts);
      document.getElementById('filterStatus').addEventListener('change', loadDrafts);

      loadDrafts();
    })();
  </script>
</AdminLayout>
