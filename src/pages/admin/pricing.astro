---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import departments from '../../data/departments.json';
import quoteRules from '../../data/quote-rules.json';
import { authenticateRequest } from '../../lib/cf-auth';

const userEmail = await authenticateRequest(Astro.request);
if (!userEmail) {
  return new Response('<h1>Access Denied</h1><p>You must be authenticated via Cloudflare Zero Trust to access the admin dashboard.</p><p><a href="/">Return to website</a></p>', { status: 403, headers: { 'Content-Type': 'text/html' } });
}

type DeptKey = keyof typeof departments;
let userDepartment: DeptKey = 'management';

for (const [key, dept] of Object.entries(departments) as [DeptKey, typeof departments[DeptKey]][]) {
  if (dept && typeof dept === 'object' && Array.isArray(dept.emails) && dept.emails.includes(userEmail)) {
    userDepartment = key;
    break;
  }
}

const canEdit = userDepartment === 'management';

const airportRates = quoteRules.airportRates as Record<string, Record<string, number>>;
const airportPricing = (quoteRules.pricing as any).airport;
const areaKeys = Object.keys(airportRates);
const airportCodes = ['BHX', 'MAN', 'EMA', 'LHR', 'LGW', 'LTN', 'STN', 'BRS', 'LPL'];
const areaNames: Record<string, string> = {
  B: 'Birmingham', M: 'Manchester', CV: 'Coventry', WS: 'Walsall',
  WV: 'Wolverhampton', DY: 'Dudley', ST: 'Stoke', DE: 'Derby',
  NG: 'Nottingham', TF: 'Telford', SY: 'Shrewsbury', LE: 'Leicester',
  S: 'Sheffield', LS: 'Leeds', LDN: 'London', default: 'Other areas'
};
---

<AdminLayout title="Pricing Configuration" userEmail={userEmail}>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-28">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Pricing Configuration</h1>
        <p class="text-gray-600 mt-1">Adjust rates, thresholds and surcharges. Changes deploy automatically via GitHub.</p>
      </div>
      <a href="/quote" target="_blank" class="text-sm text-afj-accent hover:underline">View quote wizard &rarr;</a>
    </div>

    {!canEdit ? (
      <div class="bg-amber-50 border border-amber-200 rounded-xl p-6 text-center">
        <p class="text-amber-800 font-medium">You do not have permission to edit pricing.</p>
        <p class="text-amber-600 text-sm mt-1">Only the Management department can update pricing configuration.</p>
      </div>
    ) : (
      <div>

        <!-- Section 1: Core Pricing -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-green-50 text-green-600">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
            </span>
            <h2 class="text-lg font-semibold text-gray-900">Core Pricing</h2>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cost per mile (&pound;)</label>
              <input type="number" step="0.01" min="0.10" max="5.00" id="costPerMile" value={quoteRules.costPerMile}
                class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
              <p class="text-xs text-gray-400 mt-1">Fuel + wear + insurance + depreciation</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Charge-out rate (&pound;/hr)</label>
              <input type="number" step="0.50" min="5.00" max="100.00" id="chargeOutRatePerHour" value={quoteRules.chargeOutRatePerHour}
                class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
              <p class="text-xs text-gray-400 mt-1">What we charge clients per driver hour</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Driver wage (&pound;/hr)</label>
              <input type="number" step="0.50" min="5.00" max="50.00" id="driverWagePerHour" value={quoteRules.driverWagePerHour}
                class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
              <p class="text-xs text-gray-400 mt-1">What we pay the driver (margin visibility only)</p>
            </div>
          </div>
          <div class="mt-3 text-sm text-gray-600">
            Margin per driver hour: <span id="marginDisplay" class="font-semibold text-green-600"></span>
          </div>
        </div>

        <!-- Section 2: Operational Thresholds -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-gray-100 text-gray-600">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
            </span>
            <h2 class="text-lg font-semibold text-gray-900">Operational Thresholds</h2>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Split return threshold (miles)</label>
              <input type="number" step="1" min="5" max="100" id="deadheadThresholdMiles" value={quoteRules.deadheadThresholdMiles}
                class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
              <p class="text-xs text-gray-400 mt-1">Max destination-to-base distance for split return</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Min gap for split return (hours)</label>
              <input type="number" step="0.5" min="1" max="12" id="minGapForSplitReturnHours" value={quoteRules.minGapForSplitReturnHours}
                class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
              <p class="text-xs text-gray-400 mt-1">Minimum gap to split same-day return into two legs</p>
            </div>
          </div>
        </div>

        <!-- Section 3: Passenger Multipliers (Private Hire) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-50 text-blue-600">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
            </span>
            <h2 class="text-lg font-semibold text-gray-900">Passenger Multipliers — Private Hire</h2>
          </div>
          <div class="grid grid-cols-3 sm:grid-cols-6 gap-3">
            {Object.entries(quoteRules.pricing['private-hire'].passengerMultipliers).map(([band, mult]) => (
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">{band} pax</label>
                <input type="number" step="0.05" min="0.1" max="10" data-pax-band={band} value={mult}
                  class="pax-mult pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
              </div>
            ))}
          </div>
        </div>

        <!-- Section 4: Minimum Booking Floors -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-amber-50 text-amber-600">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
            </span>
            <h2 class="text-lg font-semibold text-gray-900">Minimum Booking Floors</h2>
          </div>
          <p class="text-xs text-gray-500 mb-3">Per-tier minimums by passenger band (&pound;)</p>
          <h3 class="text-sm font-medium text-gray-700 mb-2">Private Hire</h3>
          <div class="grid grid-cols-3 sm:grid-cols-6 gap-3 mb-4">
            {Object.entries((quoteRules.minimumBooking['private-hire'] as any) || {}).map(([band, val]) => (
              <div>
                <label class="block text-xs text-gray-500 mb-1">{band} pax</label>
                <input type="number" step="5" min="0" max="1000" data-min-service="private-hire" data-min-band={band} value={val as number}
                  class="min-floor pricing-input w-full px-2 py-1.5 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40" />
              </div>
            ))}
          </div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">Airport Transfers</h3>
          <div class="grid grid-cols-3 sm:grid-cols-6 gap-3">
            {Object.entries((quoteRules.minimumBooking.airport as any) || {}).map(([band, val]) => (
              <div>
                <label class="block text-xs text-gray-500 mb-1">{band} pax</label>
                <input type="number" step="5" min="0" max="1000" data-min-service="airport" data-min-band={band} value={val as number}
                  class="min-floor pricing-input w-full px-2 py-1.5 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40" />
              </div>
            ))}
          </div>
        </div>

        <!-- Section 5: Surcharges -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-purple-50 text-purple-600">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </span>
            <h2 class="text-lg font-semibold text-gray-900">Surcharges</h2>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Early morning (before 07:00) %</label>
              <input type="number" step="1" min="0" max="200" id="surEarlyMorning" value={quoteRules.surcharges.earlyMorning.percent}
                class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Late night (after 22:00) %</label>
              <input type="number" step="1" min="0" max="200" id="surLateNight" value={quoteRules.surcharges.lateNight.percent}
                class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Saturday %</label>
              <input type="number" step="1" min="0" max="200" id="surSaturday" value={quoteRules.surcharges.saturday.percent}
                class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Sunday %</label>
              <input type="number" step="1" min="0" max="200" id="surSunday" value={quoteRules.surcharges.sunday.percent}
                class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Bank holiday %</label>
              <input type="number" step="1" min="0" max="200" id="surBankHoliday" value={quoteRules.surcharges.bankHoliday.percent}
                class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
            </div>
          </div>
        </div>

        <!-- Section 6: Airport Pricing -->
        <details class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6 group" open>
          <summary class="p-6 cursor-pointer list-none flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-sky-50 text-sky-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5a1.5 1.5 0 00-3 0V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>
              </span>
              <h2 class="text-lg font-semibold text-gray-900">Airport Pricing</h2>
            </div>
            <svg class="w-5 h-5 text-gray-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
          </summary>
          <div class="px-6 pb-6 border-t border-gray-100 pt-4">
            <!-- Airport parameters -->
            <h3 class="text-sm font-semibold text-gray-700 mb-3">Airport Parameters</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Meet & Greet (&pound;)</label>
                <input type="number" step="5" min="0" max="200" id="airportMeetGreet" value={airportPricing.meetGreetSurcharge}
                  class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Return multiplier</label>
                <input type="number" step="0.05" min="1.0" max="3.0" id="airportReturnMult" value={airportPricing.returnMultiplier}
                  class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Arrival wait (min)</label>
                <input type="number" step="5" min="0" max="120" id="airportWaitMin" value={airportPricing.arrivalWaitingMinutes}
                  class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Executive %</label>
                <input type="number" step="5" min="0" max="100" id="airportExecPercent" value={airportPricing.executivePercent}
                  class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Driver wage (&pound;/hr)</label>
                <input type="number" step="0.50" min="5" max="50" id="airportDriverWage" value={airportPricing.driverWagePerHour}
                  class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Range spread</label>
                <input type="number" step="0.05" min="0.05" max="0.50" id="airportRangeSpread" value={airportPricing.rangeSpread}
                  class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40" />
              </div>
            </div>

            <!-- Airport passenger multipliers -->
            <h3 class="text-sm font-semibold text-gray-700 mb-3">Airport Passenger Multipliers</h3>
            <div class="grid grid-cols-3 sm:grid-cols-6 gap-3 mb-6">
              {Object.entries(airportPricing.passengerMultipliers || {}).map(([band, mult]) => (
                <div>
                  <label class="block text-xs text-gray-500 mb-1">{band} pax</label>
                  <input type="number" step="0.05" min="0.1" max="10" data-pax-band={band} value={mult}
                    class="airport-pax-mult pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40" />
                </div>
              ))}
            </div>

            <!-- Airport rates matrix -->
            <h3 class="text-sm font-semibold text-gray-700 mb-3">Airport Base Rates (&pound;)</h3>
            <div class="overflow-x-auto -mx-2 px-2">
              <table class="w-full text-sm border-collapse min-w-[700px]">
                <thead>
                  <tr class="bg-gray-50">
                    <th class="sticky left-0 bg-gray-50 z-10 px-2 py-2 text-left text-xs font-medium text-gray-500 border-b border-gray-200 w-28">Area</th>
                    {airportCodes.map((code) => (
                      <th class="px-1 py-2 text-center text-xs font-medium text-gray-500 border-b border-gray-200">{code}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {areaKeys.map((area) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="sticky left-0 bg-white z-10 px-2 py-1.5 text-xs font-medium text-gray-700">
                        <span class="font-semibold">{area}</span>
                        <span class="text-gray-400 ml-1 hidden sm:inline">{areaNames[area] || ''}</span>
                      </td>
                      {airportCodes.map((code) => (
                        <td class="px-1 py-1">
                          <input type="number" step="5" min="0" max="2000"
                            data-airport-area={area} data-airport-code={code}
                            value={(airportRates[area] as any)?.[code] ?? 0}
                            class="airport-rate pricing-input w-full px-1 py-1 border border-gray-200 rounded text-xs text-center transition-colors focus:ring-1 focus:ring-afj-accent/40 focus:border-afj-accent" />
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </details>

        <!-- Section 7: Bank Holiday Dates (collapsible) -->
        <details class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6 group">
          <summary class="p-6 cursor-pointer list-none flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-rose-50 text-rose-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              </span>
              <h2 class="text-lg font-semibold text-gray-900">Bank Holiday Dates</h2>
              <span class="text-xs text-gray-400 ml-1">({quoteRules.bankHolidays.length} dates)</span>
            </div>
            <svg class="w-5 h-5 text-gray-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
          </summary>
          <div class="px-6 pb-6 border-t border-gray-100 pt-4">
            <div id="bankHolidayList" class="space-y-2 mb-3">
              {quoteRules.bankHolidays.map((d) => (
                <div class="flex items-center gap-2 bh-row">
                  <input type="date" value={d} class="bh-date px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
                  <button type="button" class="bh-remove text-gray-400 hover:text-red-500 text-xl font-bold px-2">&times;</button>
                </div>
              ))}
            </div>
            <button type="button" id="addBankHoliday" class="text-sm text-afj-accent hover:text-afj-green font-medium">+ Add date</button>
          </div>
        </details>

        <!-- Section 8: DVSA Compliance (collapsible) -->
        <details class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6 group">
          <summary class="p-6 cursor-pointer list-none flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
              </span>
              <h2 class="text-lg font-semibold text-gray-900">DVSA Compliance</h2>
            </div>
            <svg class="w-5 h-5 text-gray-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
          </summary>
          <div class="px-6 pb-6 border-t border-gray-100 pt-4">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Break threshold (hours driving)</label>
                <input type="number" step="0.5" min="1" max="10" id="dvsaBreakThreshold" value={quoteRules.dvsa.breakThresholdHours}
                  class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Break duration (minutes)</label>
                <input type="number" step="5" min="15" max="120" id="dvsaBreakDuration" value={quoteRules.dvsa.breakDurationMinutes}
                  class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Minimum passengers for break</label>
                <input type="number" step="1" min="1" max="48" id="dvsaMinPassengers" value={quoteRules.dvsa.minimumPassengers}
                  class="pricing-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />
              </div>
            </div>
          </div>
        </details>

        <!-- Section 9: Test Quote Preview -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-emerald-50 text-emerald-600">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="12" y2="14"/></svg>
            </span>
            <h2 class="text-lg font-semibold text-gray-900">Test Quote Preview</h2>
          </div>
          <p class="text-sm text-gray-500 mb-4">Compare current saved pricing against your edited values in real time.</p>

          <!-- Service toggle -->
          <div class="flex gap-2 mb-4">
            <button type="button" id="previewServicePH" class="preview-service-btn px-4 py-1.5 text-sm rounded-full font-medium bg-afj-accent text-white">Private Hire</button>
            <button type="button" id="previewServiceAP" class="preview-service-btn px-4 py-1.5 text-sm rounded-full font-medium bg-gray-100 text-gray-600 hover:bg-gray-200">Airport</button>
          </div>

          <!-- Private hire fields -->
          <div id="previewFieldsPH" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Pickup postcode</label>
              <input type="text" id="previewPickup" value="B7 4QS" placeholder="e.g. B7 4QS"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Destination</label>
              <input type="text" id="previewDest" value="M1 1AD" placeholder="e.g. M1 1AD"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Passengers</label>
              <select id="previewPax" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                <option value="1-4">1-4</option>
                <option value="5-8">5-8</option>
                <option value="9-16">9-16</option>
                <option value="17-24">17-24</option>
                <option value="25-33">25-33</option>
                <option value="34-48">34-48</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Date</label>
              <input type="date" id="previewDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Pickup time</label>
              <input type="time" id="previewTime" value="09:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Return?</label>
              <select id="previewReturn" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                <option value="no">One-way</option>
                <option value="same-day">Same-day return</option>
                <option value="different-day">Different-day return</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Return time</label>
              <input type="time" id="previewReturnTime" value="17:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div class="flex items-end">
              <button type="button" id="previewBtn"
                class="w-full bg-gray-800 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                Calculate Preview
              </button>
            </div>
          </div>

          <!-- Airport fields -->
          <div id="previewFieldsAP" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Pickup postcode</label>
              <input type="text" id="previewPickupAP" value="B7 4QS" placeholder="e.g. B7 4QS"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Airport</label>
              <select id="previewAirport" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                <option value="BHX">Birmingham (BHX)</option>
                <option value="MAN">Manchester (MAN)</option>
                <option value="EMA">East Midlands (EMA)</option>
                <option value="LHR">Heathrow (LHR)</option>
                <option value="LGW">Gatwick (LGW)</option>
                <option value="LTN">Luton (LTN)</option>
                <option value="STN">Stansted (STN)</option>
                <option value="BRS">Bristol (BRS)</option>
                <option value="LPL">Liverpool (LPL)</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Passengers</label>
              <select id="previewPaxAP" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                <option value="1-4">1-4</option>
                <option value="5-8">5-8</option>
                <option value="9-16">9-16</option>
                <option value="17-24">17-24</option>
                <option value="25-33">25-33</option>
                <option value="34-48">34-48</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Date</label>
              <input type="date" id="previewDateAP" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Pickup time</label>
              <input type="time" id="previewTimeAP" value="09:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Direction</label>
              <select id="previewDirection" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                <option value="no">Departure</option>
                <option value="yes">Arrival</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Options</label>
              <div class="flex gap-3 pt-1">
                <label class="flex items-center gap-1 text-xs text-gray-600"><input type="checkbox" id="previewMeetGreet" /> Meet & Greet</label>
                <label class="flex items-center gap-1 text-xs text-gray-600"><input type="checkbox" id="previewExec" /> Executive</label>
              </div>
            </div>
            <div class="flex items-end">
              <button type="button" id="previewBtnAP"
                class="w-full bg-gray-800 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                Calculate Preview
              </button>
            </div>
          </div>

          <!-- Results -->
          <div id="previewResult" class="hidden">
            <div class="bg-gray-50 rounded-xl p-4">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                  <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Current (saved)</h3>
                  <div id="previewCurrent" class="text-2xl font-bold text-gray-500">--</div>
                  <div id="previewCurrentDetail" class="text-xs text-gray-400 mt-1"></div>
                </div>
                <div>
                  <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">With edited values</h3>
                  <div id="previewEdited" class="text-2xl font-bold text-emerald-600">--</div>
                  <div id="previewEditedDetail" class="text-xs text-gray-400 mt-1"></div>
                  <div id="previewDelta" class="text-sm font-medium mt-1 hidden"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sticky Save Bar -->
        <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-gray-200 py-3 px-6 flex items-center justify-end gap-4 z-30">
          <div id="saveStatus" class="text-sm"></div>
          <span id="changeCount" class="text-sm text-gray-500 hidden">0 changes</span>
          <button id="saveBtn" disabled
            class="bg-afj-accent text-white font-semibold py-2.5 px-8 rounded-lg hover:bg-afj-green transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            Save Changes
          </button>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
          <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-2">Confirm Save</h3>
            <p class="text-gray-600 text-sm mb-1">You are about to update pricing configuration.</p>
            <div id="confirmChangeSummary" class="text-sm text-gray-500 mb-4"></div>
            <p class="text-xs text-amber-600 mb-4">Changes will deploy automatically via GitHub (~2 min).</p>
            <div class="flex justify-end gap-3">
              <button id="confirmCancel" class="px-4 py-2 text-sm text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
              <button id="confirmSave" class="px-4 py-2 text-sm text-white bg-afj-accent rounded-lg hover:bg-afj-green font-medium">Save Changes</button>
            </div>
          </div>
        </div>

      </div>
    )}
  </div>

  <script is:inline>
    var saveBtn = document.getElementById('saveBtn');
    var saveStatus = document.getElementById('saveStatus');
    var changeCountEl = document.getElementById('changeCount');
    var confirmModal = document.getElementById('confirmModal');

    // ── Initial values for change detection ──
    var initialValues = {};
    document.querySelectorAll('.pricing-input').forEach(function (inp) {
      var key = getInputKey(inp);
      if (key) initialValues[key] = inp.value;
    });

    function getInputKey(inp) {
      if (inp.id) return inp.id;
      if (inp.classList.contains('pax-mult')) return 'pax-' + inp.dataset.paxBand;
      if (inp.classList.contains('airport-pax-mult')) return 'apax-' + inp.dataset.paxBand;
      if (inp.classList.contains('min-floor')) return 'min-' + inp.dataset.minService + '-' + inp.dataset.minBand;
      if (inp.classList.contains('airport-rate')) return 'ar-' + inp.dataset.airportArea + '-' + inp.dataset.airportCode;
      return null;
    }

    // ── Highlight changed fields + count changes ──
    function highlightChanges() {
      var count = 0;
      document.querySelectorAll('.pricing-input').forEach(function (inp) {
        var key = getInputKey(inp);
        var initial = initialValues[key];
        if (initial !== undefined && inp.value !== initial) {
          inp.classList.add('border-amber-400', 'bg-amber-50');
          inp.classList.remove('border-gray-300', 'border-gray-200');
          count++;
        } else {
          inp.classList.remove('border-amber-400', 'bg-amber-50');
          if (inp.classList.contains('airport-rate')) {
            inp.classList.add('border-gray-200');
          } else {
            inp.classList.add('border-gray-300');
          }
        }
      });

      // Enable/disable save button
      if (saveBtn) saveBtn.disabled = count === 0;
      if (changeCountEl) {
        if (count > 0) {
          changeCountEl.textContent = count + ' change' + (count > 1 ? 's' : '');
          changeCountEl.classList.remove('hidden');
        } else {
          changeCountEl.classList.add('hidden');
        }
      }
    }

    // Bind change detection
    document.querySelectorAll('.pricing-input').forEach(function (inp) {
      inp.addEventListener('input', highlightChanges);
    });

    // ── Validation ──
    function validateAll() {
      var errors = [];
      document.querySelectorAll('.pricing-input').forEach(function (inp) {
        var val = parseFloat(inp.value);
        if (isNaN(val)) {
          errors.push({ el: inp, msg: 'Value is required' });
          return;
        }
        var min = parseFloat(inp.min);
        var max = parseFloat(inp.max);
        if (!isNaN(min) && val < min) {
          errors.push({ el: inp, msg: 'Minimum is ' + min });
        }
        if (!isNaN(max) && val > max) {
          errors.push({ el: inp, msg: 'Maximum is ' + max });
        }
      });

      // Cross-field: charge-out rate > driver wage
      var co = parseFloat(document.getElementById('chargeOutRatePerHour').value) || 0;
      var dw = parseFloat(document.getElementById('driverWagePerHour').value) || 0;
      if (co <= dw) {
        errors.push({ el: document.getElementById('chargeOutRatePerHour'), msg: 'Must exceed driver wage' });
      }

      // Show/clear error styling
      document.querySelectorAll('.pricing-input').forEach(function (inp) {
        inp.classList.remove('border-red-400', 'bg-red-50');
        var errSpan = inp.parentElement.querySelector('.field-error');
        if (errSpan) errSpan.remove();
      });

      errors.forEach(function (err) {
        err.el.classList.add('border-red-400', 'bg-red-50');
        err.el.classList.remove('border-gray-300', 'border-gray-200', 'border-amber-400', 'bg-amber-50');
        var span = document.createElement('span');
        span.className = 'field-error text-xs text-red-500 mt-0.5 block';
        span.textContent = err.msg;
        err.el.parentElement.appendChild(span);
      });

      return errors;
    }

    // ── Margin display ──
    function updateMargin() {
      var chargeOut = parseFloat(document.getElementById('chargeOutRatePerHour').value) || 0;
      var wage = parseFloat(document.getElementById('driverWagePerHour').value) || 0;
      var margin = chargeOut - wage;
      var el = document.getElementById('marginDisplay');
      if (el) {
        el.textContent = '\u00A3' + margin.toFixed(2);
        el.className = 'font-semibold ' + (margin > 0 ? 'text-green-600' : 'text-red-600');
      }
    }

    var chargeOutEl = document.getElementById('chargeOutRatePerHour');
    var wageEl = document.getElementById('driverWagePerHour');
    if (chargeOutEl) chargeOutEl.addEventListener('input', updateMargin);
    if (wageEl) wageEl.addEventListener('input', updateMargin);
    updateMargin();

    // ── Bank holiday management ──
    var bhList = document.getElementById('bankHolidayList');
    var addBhBtn = document.getElementById('addBankHoliday');

    function bindBhRemove() {
      if (!bhList) return;
      bhList.querySelectorAll('.bh-remove').forEach(function (btn) {
        btn.onclick = function () { btn.closest('.bh-row').remove(); };
      });
    }
    bindBhRemove();

    if (addBhBtn) {
      addBhBtn.addEventListener('click', function () {
        var row = document.createElement('div');
        row.className = 'flex items-center gap-2 bh-row';
        row.innerHTML =
          '<input type="date" class="bh-date px-3 py-2 border border-gray-300 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-afj-accent/40 focus:border-afj-accent" />' +
          '<button type="button" class="bh-remove text-gray-400 hover:text-red-500 text-xl font-bold px-2">&times;</button>';
        bhList.appendChild(row);
        bindBhRemove();
      });
    }

    // ── Collect config for saving ──
    function collectConfig() {
      var paxMults = {};
      document.querySelectorAll('.pax-mult').forEach(function (inp) {
        paxMults[inp.dataset.paxBand] = parseFloat(inp.value) || 1.0;
      });

      var bankHolidays = [];
      document.querySelectorAll('.bh-date').forEach(function (inp) {
        if (inp.value) bankHolidays.push(inp.value);
      });

      var airportRates = {};
      document.querySelectorAll('.airport-rate').forEach(function (inp) {
        var area = inp.dataset.airportArea;
        var code = inp.dataset.airportCode;
        if (!airportRates[area]) airportRates[area] = {};
        airportRates[area][code] = parseInt(inp.value) || 0;
      });

      var airportPaxMults = {};
      document.querySelectorAll('.airport-pax-mult').forEach(function (inp) {
        airportPaxMults[inp.dataset.paxBand] = parseFloat(inp.value) || 1.0;
      });

      return {
        costPerMile: parseFloat(document.getElementById('costPerMile').value),
        chargeOutRatePerHour: parseFloat(document.getElementById('chargeOutRatePerHour').value),
        driverWagePerHour: parseFloat(document.getElementById('driverWagePerHour').value),
        deadheadThresholdMiles: parseInt(document.getElementById('deadheadThresholdMiles').value),
        minGapForSplitReturnHours: parseFloat(document.getElementById('minGapForSplitReturnHours').value),
        minimumBooking: (function() {
          var mins = {};
          document.querySelectorAll('.min-floor').forEach(function(inp) {
            var svc = inp.dataset.minService;
            var band = inp.dataset.minBand;
            if (!mins[svc]) mins[svc] = {};
            mins[svc][band] = parseInt(inp.value) || 0;
          });
          return mins;
        })(),
        passengerMultipliers: paxMults,
        surcharges: {
          earlyMorning: { before: '07:00', percent: parseInt(document.getElementById('surEarlyMorning').value), label: 'Early morning' },
          lateNight: { after: '22:00', percent: parseInt(document.getElementById('surLateNight').value), label: 'Late night' },
          saturday: { dayOfWeek: 6, percent: parseInt(document.getElementById('surSaturday').value), label: 'Saturday' },
          sunday: { dayOfWeek: 0, percent: parseInt(document.getElementById('surSunday').value), label: 'Sunday' },
          bankHoliday: { percent: parseInt(document.getElementById('surBankHoliday').value), label: 'Bank holiday' },
        },
        bankHolidays: bankHolidays,
        dvsa: {
          breakThresholdHours: parseFloat(document.getElementById('dvsaBreakThreshold').value),
          breakDurationMinutes: parseInt(document.getElementById('dvsaBreakDuration').value),
          minimumPassengers: parseInt(document.getElementById('dvsaMinPassengers').value),
        },
        airportRates: airportRates,
        airportPricing: {
          passengerMultipliers: airportPaxMults,
          meetGreetSurcharge: parseFloat(document.getElementById('airportMeetGreet').value) || 25,
          returnMultiplier: parseFloat(document.getElementById('airportReturnMult').value) || 1.75,
          arrivalWaitingMinutes: parseInt(document.getElementById('airportWaitMin').value) || 45,
          executivePercent: parseInt(document.getElementById('airportExecPercent').value) || 30,
          driverWagePerHour: parseFloat(document.getElementById('airportDriverWage').value) || 13,
          rangeSpread: parseFloat(document.getElementById('airportRangeSpread').value) || 0.15,
        },
      };
    }

    // ── Collect config overrides for preview ──
    function collectConfigOverrides() {
      var cfg = collectConfig();
      // Restructure for the quote engine's expected format
      return {
        costPerMile: cfg.costPerMile,
        chargeOutRatePerHour: cfg.chargeOutRatePerHour,
        driverWagePerHour: cfg.driverWagePerHour,
        deadheadThresholdMiles: cfg.deadheadThresholdMiles,
        minGapForSplitReturnHours: cfg.minGapForSplitReturnHours,
        minimumBooking: cfg.minimumBooking,
        pricing: {
          'private-hire': { passengerMultipliers: cfg.passengerMultipliers },
          airport: cfg.airportPricing,
        },
        surcharges: cfg.surcharges,
        bankHolidays: cfg.bankHolidays,
        dvsa: cfg.dvsa,
        airportRates: cfg.airportRates,
      };
    }

    // ── Save handler with confirmation modal ──
    if (saveBtn) {
      saveBtn.addEventListener('click', function () {
        var errors = validateAll();
        if (errors.length > 0) {
          errors[0].el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          showStatus(errors.length + ' validation error' + (errors.length > 1 ? 's' : '') + '. Fix highlighted fields.', true);
          return;
        }
        // Show confirmation modal
        var count = changeCountEl ? changeCountEl.textContent : 'changes';
        document.getElementById('confirmChangeSummary').textContent = count + ' will be deployed.';
        confirmModal.classList.remove('hidden');
      });
    }

    document.getElementById('confirmCancel').addEventListener('click', function () {
      confirmModal.classList.add('hidden');
    });

    document.getElementById('confirmSave').addEventListener('click', function () {
      confirmModal.classList.add('hidden');
      doSave();
    });

    function doSave() {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      var config = collectConfig();

      fetch('/api/admin/pricing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config),
      })
        .then(function (res) { return res.json(); })
        .then(function (data) {
          if (data.success) {
            showStatus('Changes saved. Deployment will complete in ~2 minutes.', false);
            // Reset initial values
            document.querySelectorAll('.pricing-input').forEach(function (inp) {
              var key = getInputKey(inp);
              if (key) initialValues[key] = inp.value;
            });
            highlightChanges();
          } else {
            throw new Error(data.error || 'Failed to save');
          }
        })
        .catch(function (err) {
          showStatus(err.message || 'Failed to save changes.', true);
        })
        .finally(function () {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Changes';
          highlightChanges(); // re-check to disable if no changes
        });
    }

    function showStatus(message, isError) {
      if (!saveStatus) return;
      saveStatus.textContent = message;
      saveStatus.className = 'text-sm ' + (isError ? 'text-red-600' : 'text-green-600');
      setTimeout(function () { saveStatus.textContent = ''; }, 6000);
    }

    // ── Preview service toggle ──
    var activePreviewService = 'private-hire';
    document.getElementById('previewServicePH').addEventListener('click', function () {
      activePreviewService = 'private-hire';
      this.className = 'preview-service-btn px-4 py-1.5 text-sm rounded-full font-medium bg-afj-accent text-white';
      document.getElementById('previewServiceAP').className = 'preview-service-btn px-4 py-1.5 text-sm rounded-full font-medium bg-gray-100 text-gray-600 hover:bg-gray-200';
      document.getElementById('previewFieldsPH').classList.remove('hidden');
      document.getElementById('previewFieldsAP').classList.add('hidden');
      document.getElementById('previewResult').classList.add('hidden');
    });
    document.getElementById('previewServiceAP').addEventListener('click', function () {
      activePreviewService = 'airport';
      this.className = 'preview-service-btn px-4 py-1.5 text-sm rounded-full font-medium bg-afj-accent text-white';
      document.getElementById('previewServicePH').className = 'preview-service-btn px-4 py-1.5 text-sm rounded-full font-medium bg-gray-100 text-gray-600 hover:bg-gray-200';
      document.getElementById('previewFieldsPH').classList.add('hidden');
      document.getElementById('previewFieldsAP').classList.remove('hidden');
      document.getElementById('previewResult').classList.add('hidden');
      // Set airport date default
      if (!document.getElementById('previewDateAP').value) {
        var tmr = new Date(); tmr.setDate(tmr.getDate() + 1);
        document.getElementById('previewDateAP').value = tmr.toISOString().split('T')[0];
      }
    });

    // ── Quote preview ──
    function buildAnswers() {
      if (activePreviewService === 'airport') {
        var a = {
          pickupPostcode: document.getElementById('previewPickupAP').value,
          airport: document.getElementById('previewAirport').value,
          passengers: document.getElementById('previewPaxAP').value,
          date: document.getElementById('previewDateAP').value,
          time: document.getElementById('previewTimeAP').value,
          direction: document.getElementById('previewDirection').value,
        };
        if (document.getElementById('previewMeetGreet').checked) a.meetGreet = 'yes';
        if (document.getElementById('previewExec').checked) a.vehicleClass = 'executive';
        return a;
      }

      var answers = {
        pickupPostcode: document.getElementById('previewPickup').value,
        destinationPostcode: document.getElementById('previewDest').value,
        passengers: document.getElementById('previewPax').value,
        date: document.getElementById('previewDate').value,
        time: document.getElementById('previewTime').value,
      };

      var returnVal = document.getElementById('previewReturn').value;
      if (returnVal === 'same-day') {
        answers.returnJourney = 'yes';
        answers.returnType = 'yes';
        answers.returnPickupTime = document.getElementById('previewReturnTime').value;
      } else if (returnVal === 'different-day') {
        answers.returnJourney = 'yes';
        answers.returnType = 'no';
        var retDate = new Date(answers.date);
        retDate.setDate(retDate.getDate() + 2);
        answers.returnDate = retDate.toISOString().split('T')[0];
        answers.returnPickupTime = document.getElementById('previewReturnTime').value;
      }

      return answers;
    }

    function runPreview(btn) {
      btn.disabled = true;
      btn.textContent = 'Calculating...';

      var answers = buildAnswers();
      var service = activePreviewService;
      var overrides = collectConfigOverrides();

      // Parallel: current saved vs edited values
      Promise.all([
        fetch('/api/quote/estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ service: service, answers: answers }),
        }).then(function (r) { return r.json(); }),
        fetch('/api/admin/pricing-preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ service: service, answers: answers, configOverrides: overrides }),
        }).then(function (r) { return r.json(); }),
      ])
        .then(function (results) {
          var current = results[0];
          var edited = results[1];

          var resultEl = document.getElementById('previewResult');
          resultEl.classList.remove('hidden');

          if (current.success) {
            document.getElementById('previewCurrent').textContent =
              '\u00A3' + current.estimate.low + ' \u2013 \u00A3' + current.estimate.high;
            var detail = 'Total: \u00A3' + Math.round(current.estimate.total);
            if (current.estimate.returnType) detail += ' (' + current.estimate.returnType + ' return)';
            document.getElementById('previewCurrentDetail').textContent = detail;
          } else {
            document.getElementById('previewCurrent').textContent = 'Error';
            document.getElementById('previewCurrentDetail').textContent = current.error || 'Failed';
          }

          if (edited.success) {
            document.getElementById('previewEdited').textContent =
              '\u00A3' + edited.estimate.low + ' \u2013 \u00A3' + edited.estimate.high;
            var eDetail = 'Total: \u00A3' + Math.round(edited.estimate.total);
            if (edited.estimate.returnType) eDetail += ' (' + edited.estimate.returnType + ' return)';
            document.getElementById('previewEditedDetail').textContent = eDetail;

            // Show delta
            var deltaEl = document.getElementById('previewDelta');
            if (current.success) {
              var diff = edited.estimate.total - current.estimate.total;
              var pct = current.estimate.total > 0 ? Math.round((diff / current.estimate.total) * 100) : 0;
              if (Math.abs(diff) < 0.5) {
                deltaEl.textContent = 'No change';
                deltaEl.className = 'text-sm font-medium mt-1 text-gray-400';
              } else if (diff > 0) {
                deltaEl.textContent = '+\u00A3' + Math.round(diff) + ' (+' + pct + '%)';
                deltaEl.className = 'text-sm font-medium mt-1 text-red-500';
              } else {
                deltaEl.textContent = '-\u00A3' + Math.abs(Math.round(diff)) + ' (' + pct + '%)';
                deltaEl.className = 'text-sm font-medium mt-1 text-green-600';
              }
              deltaEl.classList.remove('hidden');
            }
          } else {
            document.getElementById('previewEdited').textContent = 'Error';
            document.getElementById('previewEditedDetail').textContent = edited.error || 'Failed';
          }
        })
        .catch(function () {
          document.getElementById('previewResult').classList.remove('hidden');
          document.getElementById('previewCurrent').textContent = 'Error';
          document.getElementById('previewCurrentDetail').textContent = 'Failed to fetch quotes';
        })
        .finally(function () {
          btn.disabled = false;
          btn.textContent = 'Calculate Preview';
        });
    }

    // Set default dates
    var tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    var dateStr = tomorrow.toISOString().split('T')[0];
    var previewDateEl = document.getElementById('previewDate');
    if (previewDateEl) previewDateEl.value = dateStr;
    var previewDateAPEl = document.getElementById('previewDateAP');
    if (previewDateAPEl) previewDateAPEl.value = dateStr;

    // Bind preview buttons
    var previewBtn = document.getElementById('previewBtn');
    if (previewBtn) previewBtn.addEventListener('click', function () { runPreview(previewBtn); });
    var previewBtnAP = document.getElementById('previewBtnAP');
    if (previewBtnAP) previewBtnAP.addEventListener('click', function () { runPreview(previewBtnAP); });
  </script>
</AdminLayout>
