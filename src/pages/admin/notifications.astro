---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import { authenticateRequest } from '../../lib/cf-auth';

const userEmail = await authenticateRequest(Astro.request);
if (!userEmail) {
  return new Response('<h1>Access Denied</h1><p>You must be authenticated via Cloudflare Zero Trust.</p><p><a href="/">Return to website</a></p>', { status: 403, headers: { 'Content-Type': 'text/html' } });
}
---

<AdminLayout title="Notifications" userEmail={userEmail}>
  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Notifications</h1>
        <p class="text-gray-600 mt-1">All system notifications â€” agent alerts, drafts, recommendations, and fixes.</p>
      </div>
      <button
        id="markAllReadBtn"
        class="bg-afj-dark-blue text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-afj-dark-blue/90 transition-colors"
      >
        Mark all as read
      </button>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-3 mb-6">
      <select id="filterType" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-afj-accent">
        <option value="">All types</option>
        <option value="blog-draft">Blog drafts</option>
        <option value="pricing-recommendation">Pricing</option>
        <option value="security-fix">Security fixes</option>
        <option value="seo-fix">SEO fixes</option>
        <option value="compliance-expiry">Compliance</option>
        <option value="social-draft">Social media</option>
        <option value="conversion-milestone">Conversions</option>
        <option value="agent-critical">Critical alerts</option>
      </select>
      <select id="filterStatus" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-afj-accent">
        <option value="">All statuses</option>
        <option value="pending">Pending</option>
        <option value="read">Read</option>
        <option value="acted">Acted</option>
      </select>
      <select id="filterPriority" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-afj-accent">
        <option value="">All priorities</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
    </div>

    <!-- Notifications list -->
    <div id="notifContainer" class="space-y-2">
      <div class="bg-white rounded-lg border border-gray-200 p-8 text-center text-gray-400">
        Loading notifications...
      </div>
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="hidden bg-white rounded-lg border border-gray-200 p-12 text-center">
      <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
      <p class="text-gray-500">No notifications matching your filters.</p>
    </div>
  </div>

  <script is:inline>
    var TYPE_EMOJIS = {
      'blog-draft': '\u{1F4DD}',
      'pricing-recommendation': '\u{1F4B0}',
      'security-fix': '\u{1F6E1}\uFE0F',
      'seo-fix': '\u{1F50D}',
      'compliance-expiry': '\u{26A0}\uFE0F',
      'social-draft': '\u{1F4F1}',
      'conversion-milestone': '\u{1F4C8}',
      'agent-critical': '\u{1F6A8}',
    };

    var STATUS_BADGES = {
      pending: '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">Pending</span>',
      read: '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">Read</span>',
      acted: '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">Acted</span>',
    };

    var PRIORITY_BADGES = {
      high: '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">High</span>',
      medium: '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">Medium</span>',
      low: '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Low</span>',
    };

    var container = document.getElementById('notifContainer');
    var emptyState = document.getElementById('emptyState');
    var allNotifications = [];

    function formatDate(dateStr) {
      var d = new Date(dateStr);
      return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function groupByDate(notifs) {
      var groups = {};
      notifs.forEach(function(n) {
        var dateKey = new Date(n.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        if (!groups[dateKey]) groups[dateKey] = [];
        groups[dateKey].push(n);
      });
      return groups;
    }

    function renderNotifications(notifs) {
      if (notifs.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      emptyState.classList.add('hidden');

      var groups = groupByDate(notifs);
      var html = '';

      Object.keys(groups).forEach(function(dateKey) {
        html += '<div class="mb-4">';
        html += '<h3 class="text-sm font-semibold text-gray-500 mb-2">' + dateKey + '</h3>';
        html += '<div class="space-y-2">';

        groups[dateKey].forEach(function(n) {
          var emoji = TYPE_EMOJIS[n.type] || '';
          var statusBadge = STATUS_BADGES[n.status] || '';
          var priorityBadge = PRIORITY_BADGES[n.priority] || '';
          var bgClass = n.status === 'pending' ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200';
          var time = new Date(n.createdAt).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

          html += '<div class="rounded-lg border p-4 ' + bgClass + ' hover:shadow-sm transition-shadow">';
          html += '  <div class="flex items-start gap-3">';
          html += '    <span class="text-xl flex-shrink-0 mt-0.5">' + emoji + '</span>';
          html += '    <div class="flex-1 min-w-0">';
          html += '      <div class="flex items-center gap-2 flex-wrap">';
          html += '        <a href="' + n.actionUrl + '" class="text-sm font-semibold text-gray-900 hover:text-afj-accent truncate">' + n.title + '</a>';
          html += '        ' + statusBadge + ' ' + priorityBadge;
          html += '      </div>';
          html += '      <p class="text-sm text-gray-600 mt-1">' + n.summary + '</p>';
          html += '      <div class="flex items-center gap-3 mt-2">';
          html += '        <span class="text-xs text-gray-400">' + time + '</span>';
          html += '        <a href="' + n.actionUrl + '" class="text-xs text-afj-accent hover:underline font-medium">Take action</a>';
          html += '      </div>';
          html += '    </div>';
          html += '  </div>';
          html += '</div>';
        });

        html += '</div></div>';
      });

      container.innerHTML = html;
    }

    function loadNotifications() {
      var params = new URLSearchParams();
      var type = document.getElementById('filterType').value;
      var status = document.getElementById('filterStatus').value;
      var priority = document.getElementById('filterPriority').value;
      if (type) params.set('type', type);
      if (status) params.set('status', status);
      if (priority) params.set('priority', priority);
      params.set('limit', '200');

      fetch('/api/admin/notifications?' + params.toString())
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success) {
            allNotifications = data.data.notifications;
            renderNotifications(allNotifications);
          }
        })
        .catch(function() {
          container.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center text-red-700">Failed to load notifications.</div>';
        });
    }

    document.getElementById('filterType').addEventListener('change', loadNotifications);
    document.getElementById('filterStatus').addEventListener('change', loadNotifications);
    document.getElementById('filterPriority').addEventListener('change', loadNotifications);

    document.getElementById('markAllReadBtn').addEventListener('click', function() {
      var pendingIds = allNotifications.filter(function(n) { return n.status === 'pending'; }).map(function(n) { return n.id; });
      if (pendingIds.length === 0) return;

      fetch('/api/admin/notifications', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'bulk-read', ids: pendingIds }),
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success) loadNotifications();
        });
    });

    loadNotifications();
  </script>
</AdminLayout>
