---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import departments from '../../data/departments.json';
import { authenticateRequest } from '../../lib/cf-auth';

const userEmail = await authenticateRequest(Astro.request);
if (!userEmail) {
  return new Response('<h1>Access Denied</h1><p>You must be authenticated via Cloudflare Zero Trust to access the admin dashboard.</p><p><a href="/">Return to website</a></p>', { status: 403, headers: { 'Content-Type': 'text/html' } });
}

// Determine permissions
type DeptKey = keyof typeof departments;
let canApprove = true;
let departmentName = 'Management';

for (const [key, dept] of Object.entries(departments) as [DeptKey, typeof departments[DeptKey]][]) {
  if (dept && typeof dept === 'object' && Array.isArray(dept.emails) && dept.emails.includes(userEmail)) {
    canApprove = dept.canApprove;
    departmentName = dept.name;
    break;
  }
}

const categories = [
  'SEND Transport',
  'Patient Transport (NEPTS)',
  'Fleet Maintenance',
  'Vehicle Conversions',
  'Professional Driver Training',
  'Private Hire',
  'Executive Minibus',
  'Airport Transfers',
  'Company News',
  'Community & CSR',
  'Industry Insights',
];

// Check if we should auto-open a specific draft
const draftParam = Astro.url.searchParams.get('draft');
---

<AdminLayout title="Content" userEmail={userEmail}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">Content Manager</h1>
      <p class="text-gray-600 mt-1">Create new posts or review AI-generated drafts.</p>
    </div>

    <!-- Tab Navigation -->
    <div class="flex border-b border-gray-200 mb-6">
      <button id="tabCreate" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-afj-accent text-afj-accent" data-tab="create">
        Create New
      </button>
      <button id="tabDrafts" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="drafts">
        Drafts
        <span id="draftCount" class="ml-1 px-1.5 py-0.5 rounded-full text-xs bg-gray-200 text-gray-600">0</span>
      </button>
    </div>

    <!-- Tab: Create New -->
    <div id="panelCreate" class="tab-panel">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left: Input Form -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Post Details</h2>
          <div class="space-y-4">
            <div>
              <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
              <input type="text" id="title" placeholder="e.g., The Importance of DBS Checks in School Transport" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-afj-accent focus:border-afj-accent text-sm" />
            </div>
            <div>
              <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <select id="category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-afj-accent focus:border-afj-accent text-sm">
                <option value="">Select a category...</option>
                {categories.map((cat) => <option value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label for="keyPoints" class="block text-sm font-medium text-gray-700 mb-1">Key Points</label>
              <textarea id="keyPoints" rows="6" placeholder="Enter the key points the blog post should cover, one per line" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-afj-accent focus:border-afj-accent text-sm"></textarea>
            </div>
            <button id="generateBtn" class="w-full bg-afj-accent text-white font-semibold py-3 px-6 rounded-lg hover:bg-afj-green transition-colors">
              Generate Draft with AI
            </button>
            <div id="statusMsg" class="hidden text-sm text-center py-2 rounded-md"></div>
          </div>
        </div>

        <!-- Right: Preview -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Preview</h2>
            <button id="editToggleBtn" class="hidden text-sm px-3 py-1.5 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">Edit</button>
          </div>
          <div id="loadingState" class="hidden flex flex-col items-center justify-center py-16 text-gray-500">
            <svg class="animate-spin h-8 w-8 text-afj-accent mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-sm">Generating draft...</p>
          </div>
          <div id="emptyState" class="flex flex-col items-center justify-center py-16 text-gray-400">
            <svg class="w-12 h-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            <p class="text-sm">Your AI-generated draft will appear here</p>
          </div>
          <div id="previewContent" class="hidden prose prose-sm max-w-none"></div>
          <textarea id="editArea" class="hidden w-full h-96 px-3 py-2 border border-gray-300 rounded-md font-mono text-xs focus:ring-2 focus:ring-afj-accent focus:border-afj-accent"></textarea>
          <div id="actionButtons" class="hidden mt-6 flex flex-col sm:flex-row gap-3">
            {canApprove ? (
              <button id="publishBtn" class="flex-1 bg-afj-accent text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-afj-green transition-colors text-sm">Publish</button>
            ) : (
              <button id="submitApprovalBtn" class="flex-1 bg-amber-500 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-amber-600 transition-colors text-sm">Submit for Approval</button>
            )}
            <button id="regenerateBtn" class="flex-1 border border-gray-300 text-gray-700 font-medium py-2.5 px-4 rounded-lg hover:bg-gray-50 transition-colors text-sm">Regenerate</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Drafts -->
    <div id="panelDrafts" class="tab-panel hidden">
      <!-- Drafts List -->
      <div id="draftsList" class="space-y-3 mb-8">
        <div class="bg-white rounded-lg border border-gray-200 p-8 text-center text-gray-400">Loading drafts...</div>
      </div>

      <!-- Draft Editor (hidden until draft selected) -->
      <div id="draftEditor" class="hidden">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <!-- Editor Header -->
          <div class="px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
              <h2 id="editorTitle" class="text-lg font-semibold text-gray-900"></h2>
              <p id="editorMeta" class="text-sm text-gray-500 mt-0.5"></p>
            </div>
            <div class="flex gap-2">
              <button id="editorPublishBtn" class="bg-afj-accent text-white text-sm font-semibold px-4 py-2 rounded-lg hover:bg-afj-green transition-colors">Publish</button>
              <button id="editorCloseBtn" class="border border-gray-300 text-gray-700 text-sm font-medium px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">Close</button>
            </div>
          </div>

          <!-- Editor Body: Side-by-side on desktop, tabbed on mobile -->
          <div class="p-6">
            <!-- Mobile tab switch -->
            <div class="flex gap-2 mb-4 md:hidden">
              <button id="mobileEditTab" class="flex-1 text-sm font-medium py-2 rounded-md bg-afj-dark-blue text-white">Edit</button>
              <button id="mobilePreviewTab" class="flex-1 text-sm font-medium py-2 rounded-md border border-gray-300 text-gray-700">Preview</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Markdown Editor -->
              <div id="editorEditPane">
                <label class="block text-sm font-medium text-gray-700 mb-2">Markdown</label>
                <textarea id="draftEditArea" class="w-full h-[500px] px-3 py-2 border border-gray-300 rounded-md font-mono text-xs focus:ring-2 focus:ring-afj-accent focus:border-afj-accent resize-y"></textarea>
                <button id="saveDraftBtn" class="mt-2 text-sm text-afj-accent hover:underline font-medium">Save changes</button>
              </div>
              <!-- Preview -->
              <div id="editorPreviewPane">
                <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
                <div id="draftPreview" class="prose prose-sm max-w-none h-[500px] overflow-y-auto border border-gray-200 rounded-md p-4 bg-gray-50"></div>
              </div>
            </div>

            <!-- AI Edit Section -->
            <div class="mt-6 border-t border-gray-200 pt-6">
              <h3 class="text-sm font-semibold text-gray-900 mb-3">Ask AI to Edit</h3>
              <div class="flex gap-3">
                <input id="aiEditInput" type="text" placeholder='e.g., "Make the intro more engaging" or "Add a section about wheelchair vehicles"' class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-afj-accent" />
                <button id="aiEditBtn" class="bg-afj-dark-blue text-white text-sm font-semibold px-4 py-2 rounded-lg hover:bg-afj-dark-blue/90 transition-colors whitespace-nowrap">Ask AI</button>
              </div>
              <!-- AI Diff panel -->
              <div id="aiDiffPanel" class="hidden mt-4 border border-gray-200 rounded-lg overflow-hidden">
                <div class="px-4 py-3 bg-gray-100 border-b border-gray-200 flex items-center justify-between">
                  <span class="text-sm font-medium text-gray-700">AI suggested changes</span>
                  <div class="flex gap-2">
                    <button id="acceptEditBtn" class="bg-green-600 text-white text-xs font-semibold px-3 py-1.5 rounded-md hover:bg-green-700">Accept</button>
                    <button id="rejectEditBtn" class="bg-red-600 text-white text-xs font-semibold px-3 py-1.5 rounded-md hover:bg-red-700">Reject</button>
                  </div>
                </div>
                <div id="aiDiffContent" class="p-4 text-sm font-mono whitespace-pre-wrap max-h-64 overflow-y-auto bg-white"></div>
              </div>
            </div>

            <!-- Edit History -->
            <div id="editHistorySection" class="hidden mt-6 border-t border-gray-200 pt-6">
              <h3 class="text-sm font-semibold text-gray-900 mb-3">Edit History</h3>
              <div id="editHistoryList" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ canApprove, draftParam }}>
    // ── Tab switching ──
    var tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(function(btn) {
      btn.addEventListener('click', function() {
        tabs.forEach(function(t) {
          t.classList.remove('border-afj-accent', 'text-afj-accent');
          t.classList.add('border-transparent', 'text-gray-500');
        });
        btn.classList.add('border-afj-accent', 'text-afj-accent');
        btn.classList.remove('border-transparent', 'text-gray-500');
        document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.add('hidden'); });
        var tabId = btn.getAttribute('data-tab');
        document.getElementById('panel' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.remove('hidden');
      });
    });

    // ── Create tab logic (same as before) ──
    var titleInput = document.getElementById('title');
    var categorySelect = document.getElementById('category');
    var keyPointsInput = document.getElementById('keyPoints');
    var generateBtn = document.getElementById('generateBtn');
    var regenerateBtn = document.getElementById('regenerateBtn');
    var editToggleBtn = document.getElementById('editToggleBtn');
    var publishBtn = document.getElementById('publishBtn');
    var submitApprovalBtn = document.getElementById('submitApprovalBtn');
    var loadingState = document.getElementById('loadingState');
    var emptyState = document.getElementById('emptyState');
    var previewContent = document.getElementById('previewContent');
    var editArea = document.getElementById('editArea');
    var actionButtons = document.getElementById('actionButtons');
    var statusMsg = document.getElementById('statusMsg');

    var currentDraft = '';
    var isEditMode = false;

    function showStatus(message, isError) {
      statusMsg.textContent = message;
      statusMsg.className = 'text-sm text-center py-2 rounded-md ' + (isError ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700');
      statusMsg.classList.remove('hidden');
      setTimeout(function() { statusMsg.classList.add('hidden'); }, 5000);
    }

    function renderMarkdown(md) {
      var html = md
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^\- (.*$)/gm, '<li>$1</li>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^---[\s\S]*?---/m, '');
      if (!html.startsWith('<')) html = '<p>' + html + '</p>';
      return html;
    }

    async function generateDraftFromForm() {
      var title = titleInput.value.trim();
      var keyPoints = keyPointsInput.value.trim();
      if (!title || !keyPoints) { showStatus('Please enter a title and key points.', true); return; }
      emptyState.classList.add('hidden');
      previewContent.classList.add('hidden');
      editArea.classList.add('hidden');
      actionButtons.classList.add('hidden');
      editToggleBtn.classList.add('hidden');
      loadingState.classList.remove('hidden');
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';
      try {
        var res = await fetch('/api/ai/draft', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: title, keyPoints: keyPoints, category: categorySelect.value, department: '' }),
        });
        var data = await res.json();
        if (data.success && data.draft) {
          currentDraft = data.draft;
          previewContent.innerHTML = renderMarkdown(data.draft);
          editArea.value = data.draft;
          loadingState.classList.add('hidden');
          previewContent.classList.remove('hidden');
          actionButtons.classList.remove('hidden');
          editToggleBtn.classList.remove('hidden');
          showStatus('Draft generated successfully!', false);
        } else { throw new Error(data.error || 'Failed'); }
      } catch (err) {
        loadingState.classList.add('hidden');
        emptyState.classList.remove('hidden');
        showStatus(err.message || 'AI drafting unavailable.', true);
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Draft with AI';
      }
    }

    function toggleEdit() {
      isEditMode = !isEditMode;
      if (isEditMode) {
        editArea.value = currentDraft;
        previewContent.classList.add('hidden');
        editArea.classList.remove('hidden');
        editToggleBtn.textContent = 'Preview';
      } else {
        currentDraft = editArea.value;
        previewContent.innerHTML = renderMarkdown(currentDraft);
        editArea.classList.add('hidden');
        previewContent.classList.remove('hidden');
        editToggleBtn.textContent = 'Edit';
      }
    }

    function extractFromDraft(draft) {
      var fm = draft.match(/^---\n([\s\S]*?)\n---/);
      var title = titleInput.value.trim();
      var description = '';
      var pubDate = new Date().toISOString().split('T')[0];
      var body = draft;
      if (fm) {
        var t = fm[1].match(/title:\s*"(.+?)"/);
        var d = fm[1].match(/description:\s*"(.+?)"/);
        if (t) title = t[1];
        if (d) description = d[1];
        body = draft.replace(/^---[\s\S]*?---\s*/, '').trim();
      }
      var slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
      return { title: title, slug: slug, description: description, pubDate: pubDate, body: body };
    }

    async function publishPost() {
      if (!currentDraft) return;
      var d = extractFromDraft(currentDraft);
      if (publishBtn) { publishBtn.disabled = true; publishBtn.textContent = 'Publishing...'; }
      try {
        var res = await fetch('/api/blog/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) });
        var data = await res.json();
        if (data.success) { showStatus('Blog post published!', false); } else { throw new Error(data.error); }
      } catch (err) { showStatus(err.message || 'Failed to publish.', true); }
      finally { if (publishBtn) { publishBtn.disabled = false; publishBtn.textContent = 'Publish'; } }
    }

    async function submitForApproval() {
      if (!currentDraft) return;
      var d = extractFromDraft(currentDraft);
      if (submitApprovalBtn) { submitApprovalBtn.disabled = true; submitApprovalBtn.textContent = 'Submitting...'; }
      try {
        var res = await fetch('/api/admin/approval', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: 'blog', title: d.title, content: currentDraft, metadata: d }) });
        var data = await res.json();
        if (data.success) { showStatus('Submitted for approval!', false); } else { throw new Error(data.error); }
      } catch (err) { showStatus(err.message || 'Failed.', true); }
      finally { if (submitApprovalBtn) { submitApprovalBtn.disabled = false; submitApprovalBtn.textContent = 'Submit for Approval'; } }
    }

    generateBtn.addEventListener('click', generateDraftFromForm);
    if (regenerateBtn) regenerateBtn.addEventListener('click', generateDraftFromForm);
    editToggleBtn.addEventListener('click', toggleEdit);
    if (publishBtn) publishBtn.addEventListener('click', publishPost);
    if (submitApprovalBtn) submitApprovalBtn.addEventListener('click', submitForApproval);

    // ── Drafts tab logic ──
    var draftsList = document.getElementById('draftsList');
    var draftEditor = document.getElementById('draftEditor');
    var draftEditArea = document.getElementById('draftEditArea');
    var draftPreview = document.getElementById('draftPreview');
    var editorTitle = document.getElementById('editorTitle');
    var editorMeta = document.getElementById('editorMeta');
    var aiEditInput = document.getElementById('aiEditInput');
    var aiEditBtn = document.getElementById('aiEditBtn');
    var aiDiffPanel = document.getElementById('aiDiffPanel');
    var aiDiffContent = document.getElementById('aiDiffContent');
    var acceptEditBtn = document.getElementById('acceptEditBtn');
    var rejectEditBtn = document.getElementById('rejectEditBtn');
    var editHistorySection = document.getElementById('editHistorySection');
    var editHistoryList = document.getElementById('editHistoryList');
    var currentEditDraft = null;
    var pendingNewContent = '';
    var pendingInstruction = '';

    var STATUS_BADGES = {
      draft: '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">Draft</span>',
      reviewing: '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">Reviewing</span>',
      published: '<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">Published</span>',
    };

    async function loadDrafts() {
      try {
        var res = await fetch('/api/admin/blog-drafts');
        var data = await res.json();
        if (data.success) {
          var drafts = data.data;
          document.getElementById('draftCount').textContent = String(drafts.length);
          if (drafts.length === 0) {
            draftsList.innerHTML = '<div class="bg-white rounded-lg border border-gray-200 p-8 text-center text-gray-400">No drafts yet. AI-generated drafts from the marketing agent will appear here.</div>';
            return;
          }
          // Sort newest first
          drafts.sort(function(a, b) { return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime(); });
          draftsList.innerHTML = drafts.map(function(d) {
            var badge = STATUS_BADGES[d.status] || '';
            var date = new Date(d.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            var wordCount = d.content.split(/\s+/).length;
            return '<div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-sm transition-shadow cursor-pointer" data-draft-id="' + d.id + '">'
              + '<div class="flex items-center justify-between">'
              + '<div class="min-w-0">'
              + '<div class="flex items-center gap-2">'
              + '<h3 class="text-sm font-semibold text-gray-900 truncate">' + d.title + '</h3>'
              + badge
              + '</div>'
              + '<p class="text-xs text-gray-500 mt-1">Source: ' + d.source + ' &middot; ' + date + ' &middot; ' + wordCount + ' words' + (d.keyword ? ' &middot; Keyword: ' + d.keyword : '') + '</p>'
              + '</div>'
              + '<svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>'
              + '</div></div>';
          }).join('');
        }
      } catch (err) {
        draftsList.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center text-red-700">Failed to load drafts.</div>';
      }
    }

    function openDraftEditor(draft) {
      currentEditDraft = draft;
      draftsList.classList.add('hidden');
      draftEditor.classList.remove('hidden');
      editorTitle.textContent = draft.title;
      var date = new Date(draft.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      editorMeta.textContent = 'Source: ' + draft.source + ' \u00B7 ' + date + (draft.keyword ? ' \u00B7 Keyword: ' + draft.keyword : '') + ' \u00B7 ' + draft.editHistory.length + ' edits';
      draftEditArea.value = draft.content;
      draftPreview.innerHTML = renderMarkdown(draft.content);
      aiDiffPanel.classList.add('hidden');

      // Show edit history
      if (draft.editHistory.length > 0) {
        editHistorySection.classList.remove('hidden');
        editHistoryList.innerHTML = draft.editHistory.map(function(h, i) {
          var time = new Date(h.timestamp).toLocaleString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
          return '<div class="flex items-center justify-between bg-gray-50 rounded-md px-3 py-2">'
            + '<div class="text-sm text-gray-700"><span class="font-medium">' + time + '</span>: ' + h.instruction + '</div>'
            + '<button class="text-xs text-red-600 hover:underline font-medium revert-btn" data-index="' + i + '">Revert</button>'
            + '</div>';
        }).join('');
      } else {
        editHistorySection.classList.add('hidden');
      }

      // Disable publish if already published
      var pubBtn = document.getElementById('editorPublishBtn');
      if (draft.status === 'published') {
        pubBtn.textContent = 'Published';
        pubBtn.disabled = true;
        pubBtn.classList.add('opacity-50');
      } else {
        pubBtn.textContent = 'Publish';
        pubBtn.disabled = false;
        pubBtn.classList.remove('opacity-50');
      }
    }

    // Click draft to open editor
    draftsList.addEventListener('click', async function(e) {
      var row = e.target.closest('[data-draft-id]');
      if (!row) return;
      var draftId = row.getAttribute('data-draft-id');
      try {
        var res = await fetch('/api/admin/blog-drafts?id=' + draftId);
        var data = await res.json();
        if (data.success) openDraftEditor(data.data);
      } catch (err) { /* ignore */ }
    });

    // Close editor
    document.getElementById('editorCloseBtn').addEventListener('click', function() {
      draftEditor.classList.add('hidden');
      draftsList.classList.remove('hidden');
      loadDrafts();
    });

    // Mobile tab switching for editor
    var mobileEditTab = document.getElementById('mobileEditTab');
    var mobilePreviewTab = document.getElementById('mobilePreviewTab');
    if (mobileEditTab) {
      mobileEditTab.addEventListener('click', function() {
        document.getElementById('editorEditPane').classList.remove('hidden');
        document.getElementById('editorPreviewPane').classList.add('hidden');
        mobileEditTab.classList.add('bg-afj-dark-blue', 'text-white');
        mobileEditTab.classList.remove('border', 'border-gray-300', 'text-gray-700');
        mobilePreviewTab.classList.remove('bg-afj-dark-blue', 'text-white');
        mobilePreviewTab.classList.add('border', 'border-gray-300', 'text-gray-700');
      });
      mobilePreviewTab.addEventListener('click', function() {
        document.getElementById('editorPreviewPane').classList.remove('hidden');
        document.getElementById('editorEditPane').classList.add('hidden');
        mobilePreviewTab.classList.add('bg-afj-dark-blue', 'text-white');
        mobilePreviewTab.classList.remove('border', 'border-gray-300', 'text-gray-700');
        mobileEditTab.classList.remove('bg-afj-dark-blue', 'text-white');
        mobileEditTab.classList.add('border', 'border-gray-300', 'text-gray-700');
      });
    }

    // Live preview update
    draftEditArea.addEventListener('input', function() {
      draftPreview.innerHTML = renderMarkdown(draftEditArea.value);
    });

    // Save draft content directly
    document.getElementById('saveDraftBtn').addEventListener('click', async function() {
      if (!currentEditDraft) return;
      try {
        var res = await fetch('/api/admin/blog-drafts', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'update-content', id: currentEditDraft.id, content: draftEditArea.value }),
        });
        var data = await res.json();
        if (data.success) {
          currentEditDraft.content = draftEditArea.value;
          showDraftStatus('Changes saved.', false);
        }
      } catch (err) { showDraftStatus('Failed to save.', true); }
    });

    function showDraftStatus(msg, isError) {
      var el = document.createElement('div');
      el.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-lg text-sm font-medium shadow-lg z-50 ' + (isError ? 'bg-red-600 text-white' : 'bg-green-600 text-white');
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(function() { el.remove(); }, 3000);
    }

    // AI Edit
    aiEditBtn.addEventListener('click', async function() {
      var instruction = aiEditInput.value.trim();
      if (!instruction || !currentEditDraft) return;
      aiEditBtn.disabled = true;
      aiEditBtn.textContent = 'Thinking...';
      try {
        var res = await fetch('/api/admin/blog-drafts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'ai-edit', id: currentEditDraft.id, instruction: instruction }),
        });
        var data = await res.json();
        if (data.success && data.data.newContent) {
          pendingNewContent = data.data.newContent;
          pendingInstruction = instruction;
          // Show simple diff
          var diffHtml = generateDiff(currentEditDraft.content, pendingNewContent);
          aiDiffContent.innerHTML = diffHtml;
          aiDiffPanel.classList.remove('hidden');
        } else { showDraftStatus('AI editing failed.', true); }
      } catch (err) { showDraftStatus('AI editing failed.', true); }
      finally { aiEditBtn.disabled = false; aiEditBtn.textContent = 'Ask AI'; }
    });

    function generateDiff(oldText, newText) {
      var oldLines = oldText.split('\n');
      var newLines = newText.split('\n');
      var html = '';
      var maxLen = Math.max(oldLines.length, newLines.length);
      for (var i = 0; i < maxLen; i++) {
        var oldLine = oldLines[i] || '';
        var newLine = newLines[i] || '';
        if (oldLine !== newLine) {
          if (oldLine) html += '<div style="background:#fecaca;padding:1px 4px">- ' + oldLine.replace(/</g, '&lt;') + '</div>';
          if (newLine) html += '<div style="background:#bbf7d0;padding:1px 4px">+ ' + newLine.replace(/</g, '&lt;') + '</div>';
        } else {
          html += '<div style="color:#6b7280;padding:1px 4px">&nbsp; ' + oldLine.replace(/</g, '&lt;') + '</div>';
        }
      }
      return html;
    }

    // Accept AI edit
    acceptEditBtn.addEventListener('click', async function() {
      if (!currentEditDraft || !pendingNewContent) return;
      try {
        var res = await fetch('/api/admin/blog-drafts', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'accept-edit', id: currentEditDraft.id, instruction: pendingInstruction, newContent: pendingNewContent }),
        });
        var data = await res.json();
        if (data.success) {
          currentEditDraft = data.data;
          draftEditArea.value = data.data.content;
          draftPreview.innerHTML = renderMarkdown(data.data.content);
          aiDiffPanel.classList.add('hidden');
          aiEditInput.value = '';
          showDraftStatus('Edit accepted.', false);
          // Refresh history
          if (data.data.editHistory.length > 0) {
            editHistorySection.classList.remove('hidden');
            editHistoryList.innerHTML = data.data.editHistory.map(function(h, i) {
              var time = new Date(h.timestamp).toLocaleString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
              return '<div class="flex items-center justify-between bg-gray-50 rounded-md px-3 py-2">'
                + '<div class="text-sm text-gray-700"><span class="font-medium">' + time + '</span>: ' + h.instruction + '</div>'
                + '<button class="text-xs text-red-600 hover:underline font-medium revert-btn" data-index="' + i + '">Revert</button>'
                + '</div>';
            }).join('');
          }
        }
      } catch (err) { showDraftStatus('Failed to accept edit.', true); }
    });

    // Reject AI edit
    rejectEditBtn.addEventListener('click', function() {
      aiDiffPanel.classList.add('hidden');
      pendingNewContent = '';
      pendingInstruction = '';
    });

    // Revert history
    editHistoryList.addEventListener('click', async function(e) {
      var btn = e.target.closest('.revert-btn');
      if (!btn || !currentEditDraft) return;
      var index = parseInt(btn.getAttribute('data-index'));
      if (!confirm('Revert to version before this edit?')) return;
      try {
        var res = await fetch('/api/admin/blog-drafts', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'revert', id: currentEditDraft.id, historyIndex: index }),
        });
        var data = await res.json();
        if (data.success) {
          currentEditDraft = data.data;
          draftEditArea.value = data.data.content;
          draftPreview.innerHTML = renderMarkdown(data.data.content);
          showDraftStatus('Reverted to earlier version.', false);
          // Refresh
          openDraftEditor(data.data);
        }
      } catch (err) { showDraftStatus('Failed to revert.', true); }
    });

    // Publish from editor
    document.getElementById('editorPublishBtn').addEventListener('click', async function() {
      if (!currentEditDraft) return;
      if (!confirm('This will publish "' + currentEditDraft.title + '" to the blog. It will be live within 2 minutes.')) return;
      var btn = document.getElementById('editorPublishBtn');
      btn.disabled = true;
      btn.textContent = 'Publishing...';
      try {
        var res = await fetch('/api/admin/blog-drafts', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'publish', id: currentEditDraft.id }),
        });
        var data = await res.json();
        if (data.success) {
          showDraftStatus('Published! Live at ' + data.data.url, false);
          btn.textContent = 'Published';
          btn.classList.add('opacity-50');
        } else { throw new Error(data.error); }
      } catch (err) {
        showDraftStatus(err.message || 'Failed to publish.', true);
        btn.disabled = false;
        btn.textContent = 'Publish';
      }
    });

    // Initial load
    loadDrafts();

    // Auto-open draft if ?draft=... param
    if (draftParam) {
      // Switch to drafts tab
      document.querySelector('[data-tab="drafts"]').click();
      setTimeout(async function() {
        try {
          var res = await fetch('/api/admin/blog-drafts?id=' + draftParam);
          var data = await res.json();
          if (data.success) openDraftEditor(data.data);
        } catch (err) { /* ignore */ }
      }, 300);
    }
  </script>
</AdminLayout>
