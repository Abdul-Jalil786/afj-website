---
export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import fs from 'node:fs';
import path from 'node:path';

// Parse content-calendar.csv at render time
const csvPath = path.join(process.cwd(), 'seo', 'content-calendar.csv');
let calendarRows: { week: string; date: string; type: string; title: string; keyword: string; targetPage: string; status: string }[] = [];

try {
  const csvContent = fs.readFileSync(csvPath, 'utf-8');
  const lines = csvContent.trim().split('\n');
  // Skip header row
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',');
    if (cols.length >= 7) {
      calendarRows.push({
        week: cols[0],
        date: cols[1],
        type: cols[2],
        title: cols.slice(3, cols.length - 2).join(','), // Handle commas in titles
        keyword: cols[cols.length - 2],
        targetPage: cols[cols.length - 1],
        status: 'Draft',
      });
    }
  }
} catch {
  // CSV not found or parse error
}

// Better CSV parsing: re-parse properly
calendarRows = [];
try {
  const csvContent = fs.readFileSync(csvPath, 'utf-8');
  const lines = csvContent.trim().split('\n');
  for (let i = 1; i < lines.length; i++) {
    // Simple CSV parse that handles the known format
    const line = lines[i];
    const parts: string[] = [];
    let current = '';
    let inQuotes = false;
    for (const char of line) {
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        parts.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    parts.push(current.trim());

    if (parts.length >= 6) {
      calendarRows.push({
        week: parts[0],
        date: parts[1],
        type: parts[2],
        title: parts[3],
        keyword: parts[4],
        targetPage: parts[5],
        status: parts[6] || 'Draft',
      });
    }
  }
} catch {
  // fallback
}

// Social media posting schedule
const socialSchedule = [
  { day: 'Monday', facebook: { type: 'Service highlight', time: '10:00', desc: 'Showcase a specific AFJ service with key stats and benefits' }, linkedin: { type: 'Industry insight', time: '08:30', desc: 'Share thought leadership or industry trends' } },
  { day: 'Wednesday', facebook: { type: 'Community story / testimonial', time: '10:00', desc: 'Share customer feedback or community involvement' }, linkedin: { type: 'Company update', time: '08:30', desc: 'Announce contract wins, milestones, or news' } },
  { day: 'Friday', facebook: { type: 'Behind-the-scenes / team', time: '10:00', desc: 'Team spotlight or behind-the-scenes content' }, linkedin: { type: 'Recruitment / careers', time: '08:30', desc: 'Job openings and career opportunities' } },
];

// Template data
const templates = [
  { platform: 'Facebook', name: 'Service Highlight', file: 'service-highlight.md', desc: 'Showcase a specific AFJ service with key stats, benefits, and differentiators' },
  { platform: 'Facebook', name: 'Testimonial Share', file: 'testimonial-share.md', desc: 'Share customer testimonials with a thank-you message and CTA' },
  { platform: 'Facebook', name: 'Job Vacancy', file: 'job-vacancy.md', desc: 'Recruitment posts with role details, benefits, and application info' },
  { platform: 'Facebook', name: 'Blog Share', file: 'blog-share.md', desc: 'Promote blog articles with an engaging hook and link' },
  { platform: 'Facebook', name: 'Community Update', file: 'community-update.md', desc: 'Community initiatives, events, or partnership announcements' },
  { platform: 'LinkedIn', name: 'Company Update', file: 'company-update.md', desc: 'Professional announcements of company news and achievements' },
  { platform: 'LinkedIn', name: 'Contract Win', file: 'contract-win.md', desc: 'Announce new contract awards with scope and relevant stats' },
  { platform: 'LinkedIn', name: 'Industry Insight', file: 'industry-insight.md', desc: 'Share industry observations and trends from 18+ years of experience' },
  { platform: 'LinkedIn', name: 'Recruitment', file: 'recruitment.md', desc: 'Professional job postings with requirements and QualSafe training benefits' },
  { platform: 'LinkedIn', name: 'Thought Leadership', file: 'thought-leadership.md', desc: 'Longer-form opinion pieces with bold statements and concrete examples' },
];

// Summary stats
const today = new Date();
const todayStr = today.toISOString().split('T')[0];
const thisWeekEnd = new Date(today);
thisWeekEnd.setDate(today.getDate() + (7 - today.getDay()));
const totalPlanned = calendarRows.length;
const dueThisWeek = calendarRows.filter(r => {
  const d = new Date(r.date);
  return d >= today && d <= thisWeekEnd;
}).length;
const overdue = calendarRows.filter(r => new Date(r.date) < today).length;

// Serialise data for client JS
const calendarDataJson = JSON.stringify(calendarRows);
const socialDataJson = JSON.stringify(socialSchedule);
---

<BaseLayout title="Content Calendar — AFJ Limited (Internal)">
  <meta slot="head" name="robots" content="noindex, nofollow" />

  <Header />

  <main class="min-h-screen bg-gray-50">
    <!-- Page Header -->
    <div class="bg-afj-dark-blue text-white py-8">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold mb-2">Content Calendar</h1>
        <p class="text-white/70">Internal dashboard for managing blog and social media content.</p>
        <div class="flex flex-wrap gap-6 mt-4">
          <div class="bg-white/10 rounded-lg px-4 py-2">
            <span class="text-2xl font-bold">{totalPlanned}</span>
            <span class="text-white/70 text-sm ml-1">planned posts</span>
          </div>
          <div class="bg-white/10 rounded-lg px-4 py-2">
            <span class="text-2xl font-bold">{dueThisWeek}</span>
            <span class="text-white/70 text-sm ml-1">due this week</span>
          </div>
          <div class="bg-white/10 rounded-lg px-4 py-2">
            <span class="text-2xl font-bold text-red-300">{overdue}</span>
            <span class="text-white/70 text-sm ml-1">overdue</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="sticky top-0 z-30 bg-white border-b border-gray-200 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <nav class="flex gap-1" id="tab-nav">
          <button data-tab="calendar" class="tab-btn active px-4 py-3 text-sm font-medium border-b-2 border-afj-dark-blue text-afj-dark-blue">Calendar</button>
          <button data-tab="blog" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Blog Posts</button>
          <button data-tab="social" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Social Media</button>
          <button data-tab="templates" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Templates</button>
        </nav>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

      <!-- ===== CALENDAR TAB ===== -->
      <div id="tab-calendar" class="tab-content">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <button id="cal-prev" class="p-2 hover:bg-gray-100 rounded-lg text-gray-600">&larr; Previous</button>
            <h2 id="cal-month-label" class="text-lg font-semibold text-afj-dark-blue"></h2>
            <button id="cal-next" class="p-2 hover:bg-gray-100 rounded-lg text-gray-600">Next &rarr;</button>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-7 gap-px bg-gray-200 rounded-lg overflow-hidden" id="cal-grid">
              <!-- Days of week headers -->
              <div class="bg-gray-50 p-2 text-center text-xs font-medium text-gray-500">Mon</div>
              <div class="bg-gray-50 p-2 text-center text-xs font-medium text-gray-500">Tue</div>
              <div class="bg-gray-50 p-2 text-center text-xs font-medium text-gray-500">Wed</div>
              <div class="bg-gray-50 p-2 text-center text-xs font-medium text-gray-500">Thu</div>
              <div class="bg-gray-50 p-2 text-center text-xs font-medium text-gray-500">Fri</div>
              <div class="bg-gray-50 p-2 text-center text-xs font-medium text-gray-500">Sat</div>
              <div class="bg-gray-50 p-2 text-center text-xs font-medium text-gray-500">Sun</div>
            </div>
            <!-- Day detail panel -->
            <div id="cal-detail" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
              <h3 id="cal-detail-title" class="font-semibold text-afj-dark-blue mb-2"></h3>
              <div id="cal-detail-items"></div>
            </div>
          </div>
          <div class="px-4 pb-4 flex gap-4 text-xs text-gray-500">
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-500 inline-block"></span> Blog</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500 inline-block"></span> Facebook</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-purple-500 inline-block"></span> LinkedIn</span>
          </div>
        </div>
      </div>

      <!-- ===== BLOG POSTS TAB ===== -->
      <div id="tab-blog" class="tab-content hidden">
        <!-- Blog table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
          <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-afj-dark-blue">Planned Blog Posts</h2>
            <button id="btn-create-blog" class="bg-afj-accent hover:bg-afj-green text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">+ Create New Blog Post</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">Week</th>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">Date</th>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">Title</th>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">Keyword</th>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">Target Page</th>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">Status</th>
                </tr>
              </thead>
              <tbody id="blog-table-body">
                {calendarRows.map((row, i) => (
                  <tr class="border-t border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3 text-gray-600">{row.week}</td>
                    <td class="px-4 py-3 text-gray-600 whitespace-nowrap">{row.date}</td>
                    <td class="px-4 py-3 font-medium text-afj-text">{row.title}</td>
                    <td class="px-4 py-3 text-gray-500 text-xs">{row.keyword}</td>
                    <td class="px-4 py-3">
                      <code class="text-xs bg-gray-100 px-1.5 py-0.5 rounded">{row.targetPage}</code>
                    </td>
                    <td class="px-4 py-3">
                      <button
                        class="status-toggle text-xs font-medium px-2.5 py-1 rounded-full cursor-pointer"
                        data-row={i}
                      >
                        {row.status}
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Blog creation form (hidden by default) -->
        <div id="blog-form-panel" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hidden">
          <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-afj-dark-blue">Create New Blog Post</h2>
            <button id="btn-close-form" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
          </div>
          <form id="blog-create-form" class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                <input type="text" name="title" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-afj-accent focus:border-afj-accent" placeholder="e.g. The Complete Guide to SEND School Transport" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Slug *</label>
                <input type="text" name="slug" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-afj-accent focus:border-afj-accent" placeholder="auto-generated-from-title" />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Description / Meta Description * <span class="text-gray-400 text-xs" id="desc-counter">(0/155)</span></label>
              <textarea name="description" required maxlength="155" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-afj-accent focus:border-afj-accent" placeholder="Meta description under 155 characters with primary keyword"></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Publish Date *</label>
                <input type="date" name="pubDate" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-afj-accent focus:border-afj-accent" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                <input type="text" name="tags" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-afj-accent focus:border-afj-accent" placeholder="SEND transport, Birmingham" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Featured Image Path</label>
                <input type="text" name="image" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-afj-accent focus:border-afj-accent" placeholder="../assets/images/blog/image.jpg" />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Image Alt Text</label>
              <input type="text" name="imageAlt" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-afj-accent focus:border-afj-accent" placeholder="Descriptive alt text for the featured image" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Body Content (Markdown) *</label>
              <textarea name="body" required rows="12" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm font-mono focus:ring-2 focus:ring-afj-accent focus:border-afj-accent" placeholder="Write your blog post content in Markdown..."></textarea>
            </div>
            <div class="flex items-center gap-4">
              <button type="submit" id="btn-submit-blog" class="bg-afj-accent hover:bg-afj-green text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-colors">Create &amp; Push</button>
              <span id="blog-form-status" class="text-sm"></span>
            </div>
          </form>
        </div>
      </div>

      <!-- ===== SOCIAL MEDIA TAB ===== -->
      <div id="tab-social" class="tab-content hidden">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-afj-dark-blue">Weekly Social Media Schedule</h2>
            <p class="text-sm text-gray-500 mt-1">Posts are due every Monday, Wednesday, and Friday on both Facebook and LinkedIn.</p>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">Day</th>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">
                    <span class="inline-flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-green-500 inline-block"></span> Facebook (10:00)</span>
                  </th>
                  <th class="text-left px-4 py-3 font-medium text-gray-500">
                    <span class="inline-flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-full bg-purple-500 inline-block"></span> LinkedIn (08:30)</span>
                  </th>
                  <th class="text-center px-4 py-3 font-medium text-gray-500">Actions</th>
                </tr>
              </thead>
              <tbody>
                {socialSchedule.map((row) => (
                  <tr class="border-t border-gray-100">
                    <td class="px-4 py-4 font-medium text-afj-text">{row.day}</td>
                    <td class="px-4 py-4">
                      <div class="font-medium text-green-700">{row.facebook.type}</div>
                      <div class="text-xs text-gray-500 mt-1">{row.facebook.desc}</div>
                    </td>
                    <td class="px-4 py-4">
                      <div class="font-medium text-purple-700">{row.linkedin.type}</div>
                      <div class="text-xs text-gray-500 mt-1">{row.linkedin.desc}</div>
                    </td>
                    <td class="px-4 py-4 text-center">
                      <div class="flex flex-col gap-1">
                        <button
                          class="notify-btn text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-1.5 rounded font-medium transition-colors"
                          data-type={row.facebook.type}
                          data-platform="Facebook"
                          data-day={row.day}
                        >
                          Remind (FB)
                        </button>
                        <button
                          class="notify-btn text-xs bg-purple-50 hover:bg-purple-100 text-purple-700 px-3 py-1.5 rounded font-medium transition-colors"
                          data-type={row.linkedin.type}
                          data-platform="LinkedIn"
                          data-day={row.day}
                        >
                          Remind (LI)
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ===== TEMPLATES TAB ===== -->
      <div id="tab-templates" class="tab-content hidden">
        <div class="mb-6">
          <h2 class="text-lg font-semibold text-afj-dark-blue mb-1">Social Media Templates</h2>
          <p class="text-sm text-gray-500">Quick reference for all Facebook and LinkedIn post templates.</p>
        </div>

        <h3 class="text-base font-semibold text-green-700 mb-3 flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-green-500 inline-block"></span> Facebook Templates
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
          {templates.filter(t => t.platform === 'Facebook').map((t) => (
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-medium text-afj-text">{t.name}</h4>
                <span class="text-xs bg-green-50 text-green-700 px-2 py-0.5 rounded-full">Facebook</span>
              </div>
              <p class="text-sm text-gray-500 mb-3">{t.desc}</p>
              <div class="flex items-center gap-2">
                <code class="text-xs bg-gray-100 px-2 py-1 rounded flex-1 truncate">{t.file}</code>
                <button
                  class="copy-template-btn text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded font-medium transition-colors"
                  data-path={`social-media/content/facebook/templates/${t.file}`}
                >
                  Copy Path
                </button>
              </div>
            </div>
          ))}
        </div>

        <h3 class="text-base font-semibold text-purple-700 mb-3 flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-purple-500 inline-block"></span> LinkedIn Templates
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {templates.filter(t => t.platform === 'LinkedIn').map((t) => (
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-medium text-afj-text">{t.name}</h4>
                <span class="text-xs bg-purple-50 text-purple-700 px-2 py-0.5 rounded-full">LinkedIn</span>
              </div>
              <p class="text-sm text-gray-500 mb-3">{t.desc}</p>
              <div class="flex items-center gap-2">
                <code class="text-xs bg-gray-100 px-2 py-1 rounded flex-1 truncate">{t.file}</code>
                <button
                  class="copy-template-btn text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded font-medium transition-colors"
                  data-path={`social-media/content/linkedin/templates/${t.file}`}
                >
                  Copy Path
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>

    </div>
  </main>

  <Footer />
</BaseLayout>

<script define:vars={{ calendarDataJson, socialDataJson }}>
  // ===== TAB SWITCHING =====
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const tabId = btn.getAttribute('data-tab');
      tabButtons.forEach(b => {
        b.classList.remove('active', 'border-afj-dark-blue', 'text-afj-dark-blue');
        b.classList.add('border-transparent', 'text-gray-500');
      });
      btn.classList.add('active', 'border-afj-dark-blue', 'text-afj-dark-blue');
      btn.classList.remove('border-transparent', 'text-gray-500');
      tabContents.forEach(tc => tc.classList.add('hidden'));
      document.getElementById('tab-' + tabId)?.classList.remove('hidden');
    });
  });

  // ===== CALENDAR =====
  const calendarData = JSON.parse(calendarDataJson);
  const calGrid = document.getElementById('cal-grid');
  const calLabel = document.getElementById('cal-month-label');
  const calDetail = document.getElementById('cal-detail');
  const calDetailTitle = document.getElementById('cal-detail-title');
  const calDetailItems = document.getElementById('cal-detail-items');

  // Build a date -> items map for blog posts
  const dateMap = {};
  calendarData.forEach(row => {
    const dateKey = row.date;
    if (!dateMap[dateKey]) dateMap[dateKey] = [];
    dateMap[dateKey].push({ type: row.type, title: row.title, keyword: row.keyword });
  });

  // Add recurring social media entries for each week
  // Social posts fall on Mon/Wed/Fri
  function addSocialDates(year, month) {
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
      const date = new Date(year, month, d);
      const dow = date.getDay(); // 0=Sun
      const dateKey = date.toISOString().split('T')[0];
      if (dow === 1) { // Monday
        if (!dateMap[dateKey]) dateMap[dateKey] = [];
        const hasFb = dateMap[dateKey].some(i => i.type === 'Facebook');
        const hasLi = dateMap[dateKey].some(i => i.type === 'LinkedIn');
        if (!hasFb) dateMap[dateKey].push({ type: 'Facebook', title: 'Service highlight', keyword: '' });
        if (!hasLi) dateMap[dateKey].push({ type: 'LinkedIn', title: 'Industry insight / thought leadership', keyword: '' });
      } else if (dow === 3) { // Wednesday
        if (!dateMap[dateKey]) dateMap[dateKey] = [];
        const hasFb = dateMap[dateKey].some(i => i.type === 'Facebook');
        const hasLi = dateMap[dateKey].some(i => i.type === 'LinkedIn');
        if (!hasFb) dateMap[dateKey].push({ type: 'Facebook', title: 'Community story / testimonial', keyword: '' });
        if (!hasLi) dateMap[dateKey].push({ type: 'LinkedIn', title: 'Company update / contract news', keyword: '' });
      } else if (dow === 5) { // Friday
        if (!dateMap[dateKey]) dateMap[dateKey] = [];
        const hasFb = dateMap[dateKey].some(i => i.type === 'Facebook');
        const hasLi = dateMap[dateKey].some(i => i.type === 'LinkedIn');
        if (!hasFb) dateMap[dateKey].push({ type: 'Facebook', title: 'Behind-the-scenes / team spotlight', keyword: '' });
        if (!hasLi) dateMap[dateKey].push({ type: 'LinkedIn', title: 'Recruitment / career opportunity', keyword: '' });
      }
    }
  }

  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();

  function renderCalendar() {
    // Add social dates for current month view
    addSocialDates(currentYear, currentMonth);

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    calLabel.textContent = monthNames[currentMonth] + ' ' + currentYear;

    // Remove old day cells (keep 7 header cells)
    while (calGrid.children.length > 7) {
      calGrid.removeChild(calGrid.lastChild);
    }

    const firstDay = new Date(currentYear, currentMonth, 1);
    // getDay() returns 0=Sun, we want Mon=0
    let startDay = firstDay.getDay() - 1;
    if (startDay < 0) startDay = 6;

    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const todayStr = new Date().toISOString().split('T')[0];

    // Empty cells before first day
    for (let i = 0; i < startDay; i++) {
      const cell = document.createElement('div');
      cell.className = 'bg-white p-2 min-h-[70px]';
      calGrid.appendChild(cell);
    }

    // Day cells
    for (let d = 1; d <= daysInMonth; d++) {
      const dateObj = new Date(currentYear, currentMonth, d);
      const dateKey = dateObj.toISOString().split('T')[0];
      const isToday = dateKey === todayStr;
      const items = dateMap[dateKey] || [];

      const cell = document.createElement('div');
      cell.className = 'bg-white p-2 min-h-[70px] cursor-pointer hover:bg-gray-50 transition-colors' + (isToday ? ' ring-2 ring-inset ring-afj-accent' : '');

      const dayNum = document.createElement('div');
      dayNum.className = 'text-sm font-medium ' + (isToday ? 'text-afj-accent font-bold' : 'text-gray-700');
      dayNum.textContent = String(d);
      cell.appendChild(dayNum);

      // Add dots for content
      if (items.length > 0) {
        const dotsDiv = document.createElement('div');
        dotsDiv.className = 'flex flex-wrap gap-0.5 mt-1';
        items.forEach(item => {
          const dot = document.createElement('span');
          let colour = 'bg-blue-500'; // Blog
          if (item.type === 'Facebook') colour = 'bg-green-500';
          if (item.type === 'LinkedIn') colour = 'bg-purple-500';
          dot.className = 'w-2 h-2 rounded-full ' + colour;
          dot.title = item.type + ': ' + item.title;
          dotsDiv.appendChild(dot);
        });
        cell.appendChild(dotsDiv);
      }

      cell.addEventListener('click', () => {
        if (items.length === 0) {
          calDetail.classList.add('hidden');
          return;
        }
        calDetailTitle.textContent = dateKey;
        calDetailItems.innerHTML = '';
        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'flex items-center gap-2 py-1';
          let colour = 'bg-blue-500';
          let label = 'Blog';
          if (item.type === 'Facebook') { colour = 'bg-green-500'; label = 'Facebook'; }
          if (item.type === 'LinkedIn') { colour = 'bg-purple-500'; label = 'LinkedIn'; }
          div.innerHTML = '<span class="w-2.5 h-2.5 rounded-full ' + colour + ' inline-block flex-shrink-0"></span>' +
            '<span class="text-xs font-medium text-gray-500 w-16">' + label + '</span>' +
            '<span class="text-sm text-afj-text">' + item.title + '</span>' +
            (item.keyword ? '<span class="text-xs text-gray-400 ml-auto">' + item.keyword + '</span>' : '');
          calDetailItems.appendChild(div);
        });
        calDetail.classList.remove('hidden');
      });

      calGrid.appendChild(cell);
    }
  }

  document.getElementById('cal-prev').addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 0) { currentMonth = 11; currentYear--; }
    renderCalendar();
  });
  document.getElementById('cal-next').addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
    renderCalendar();
  });

  renderCalendar();

  // ===== BLOG STATUS TOGGLES =====
  const statusCycle = ['Draft', 'Scheduled', 'Published'];
  const statusColours = {
    Draft: 'bg-gray-100 text-gray-600',
    Scheduled: 'bg-amber-100 text-amber-700',
    Published: 'bg-green-100 text-green-700',
  };

  // Load statuses from localStorage
  const savedStatuses = JSON.parse(localStorage.getItem('afj-blog-statuses') || '{}');

  document.querySelectorAll('.status-toggle').forEach(btn => {
    const idx = btn.getAttribute('data-row');
    const saved = savedStatuses[idx];
    const initial = saved || btn.textContent.trim();
    btn.textContent = initial;
    btn.className = 'status-toggle text-xs font-medium px-2.5 py-1 rounded-full cursor-pointer ' + (statusColours[initial] || statusColours.Draft);

    btn.addEventListener('click', () => {
      const current = btn.textContent.trim();
      const nextIdx = (statusCycle.indexOf(current) + 1) % statusCycle.length;
      const next = statusCycle[nextIdx];
      btn.textContent = next;
      btn.className = 'status-toggle text-xs font-medium px-2.5 py-1 rounded-full cursor-pointer ' + statusColours[next];
      savedStatuses[idx] = next;
      localStorage.setItem('afj-blog-statuses', JSON.stringify(savedStatuses));
    });
  });

  // ===== BLOG FORM =====
  const blogFormPanel = document.getElementById('blog-form-panel');
  const blogForm = document.getElementById('blog-create-form');
  const formStatus = document.getElementById('blog-form-status');

  document.getElementById('btn-create-blog').addEventListener('click', () => {
    blogFormPanel.classList.remove('hidden');
    blogFormPanel.scrollIntoView({ behavior: 'smooth' });
  });

  document.getElementById('btn-close-form').addEventListener('click', () => {
    blogFormPanel.classList.add('hidden');
  });

  // Auto-generate slug from title
  const titleInput = blogForm.querySelector('[name="title"]');
  const slugInput = blogForm.querySelector('[name="slug"]');
  titleInput.addEventListener('input', () => {
    if (!slugInput.dataset.manual) {
      slugInput.value = titleInput.value
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
    }
  });
  slugInput.addEventListener('input', () => {
    slugInput.dataset.manual = 'true';
  });

  // Description character counter
  const descArea = blogForm.querySelector('[name="description"]');
  const descCounter = document.getElementById('desc-counter');
  descArea.addEventListener('input', () => {
    descCounter.textContent = '(' + descArea.value.length + '/155)';
  });

  // Form submission
  blogForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('btn-submit-blog');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    formStatus.textContent = '';
    formStatus.className = 'text-sm';

    const formData = new FormData(blogForm);
    const payload = {
      title: formData.get('title'),
      slug: formData.get('slug'),
      description: formData.get('description'),
      pubDate: formData.get('pubDate'),
      tags: formData.get('tags'),
      image: formData.get('image'),
      imageAlt: formData.get('imageAlt'),
      body: formData.get('body'),
    };

    // Prompt for dashboard secret
    const secret = prompt('Enter the dashboard secret key:');
    if (!secret) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Create & Push';
      return;
    }

    try {
      const res = await fetch('/api/blog/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-dashboard-secret': secret,
        },
        body: JSON.stringify(payload),
      });

      const data = await res.json();

      if (res.ok) {
        formStatus.textContent = data.message + (data.url ? ' — View on GitHub' : '');
        formStatus.className = 'text-sm text-green-700';
        blogForm.reset();
        slugInput.dataset.manual = '';
      } else {
        formStatus.textContent = 'Error: ' + (data.error || 'Unknown error') + (data.details ? ' — ' + data.details : '');
        formStatus.className = 'text-sm text-red-600';
      }
    } catch (err) {
      formStatus.textContent = 'Network error: ' + err.message;
      formStatus.className = 'text-sm text-red-600';
    }

    submitBtn.disabled = false;
    submitBtn.textContent = 'Create & Push';
  });

  // ===== NOTIFICATION BUTTONS =====
  document.querySelectorAll('.notify-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const type = btn.getAttribute('data-type');
      const platform = btn.getAttribute('data-platform');
      const day = btn.getAttribute('data-day');

      const secret = prompt('Enter the dashboard secret key:');
      if (!secret) return;

      // Calculate the next occurrence of this day
      const dayMap = { Monday: 1, Tuesday: 2, Wednesday: 3, Thursday: 4, Friday: 5, Saturday: 6, Sunday: 0 };
      const targetDay = dayMap[day];
      const now = new Date();
      let diff = targetDay - now.getDay();
      if (diff <= 0) diff += 7;
      const nextDate = new Date(now);
      nextDate.setDate(now.getDate() + diff);
      const dueDate = nextDate.toISOString().split('T')[0];

      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = 'Sending...';

      try {
        const res = await fetch('/api/notify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-dashboard-secret': secret,
          },
          body: JSON.stringify({ type, platform, title: type + ' (' + day + ')', dueDate }),
        });

        const data = await res.json();

        if (res.ok) {
          btn.textContent = 'Sent!';
          btn.className = btn.className.replace(/bg-\w+-50/g, 'bg-green-50').replace(/text-\w+-700/g, 'text-green-700');
          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 2000);
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
          btn.textContent = originalText;
          btn.disabled = false;
        }
      } catch (err) {
        alert('Network error: ' + err.message);
        btn.textContent = originalText;
        btn.disabled = false;
      }
    });
  });

  // ===== COPY TEMPLATE PATH =====
  document.querySelectorAll('.copy-template-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const path = btn.getAttribute('data-path');
      navigator.clipboard.writeText(path).then(() => {
        const original = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = original; }, 1500);
      });
    });
  });
</script>
