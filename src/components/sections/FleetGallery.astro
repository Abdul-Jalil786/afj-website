---
interface GalleryImage {
  src: string;
  alt: string;
}

interface Props {
  images: GalleryImage[];
  heading?: string;
}

const { images, heading } = Astro.props;
---

<section class="section-padding">
  <div class="container-wide">
    {heading && (
      <h2 class="text-afj-green text-center mb-8">{heading}</h2>
    )}

    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      {images.map((image, index) => (
        <button
          class="gallery-item relative aspect-square overflow-hidden rounded-lg group cursor-pointer bg-afj-light-white focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-afj-accent"
          data-index={index}
          data-src={image.src}
          data-alt={image.alt}
          aria-label={`View image: ${image.alt}`}
        >
          <img
            src={image.src}
            alt={image.alt}
            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
            loading="lazy"
          />
          <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center">
            <svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
            </svg>
          </div>
        </button>
      ))}
    </div>
  </div>
</section>

<!-- Lightbox -->
<div id="gallery-lightbox" class="fixed inset-0 z-50 hidden bg-black/90 flex items-center justify-center" role="dialog" aria-modal="true" aria-label="Image gallery">
  <button id="lightbox-close" class="absolute top-4 right-4 text-white w-10 h-10 flex items-center justify-center hover:text-afj-accent focus-visible:outline-2 focus-visible:outline-white" aria-label="Close gallery">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>
  <button id="lightbox-prev" class="absolute left-4 top-1/2 -translate-y-1/2 text-white w-10 h-10 flex items-center justify-center hover:text-afj-accent focus-visible:outline-2 focus-visible:outline-white" aria-label="Previous image">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
  </button>
  <button id="lightbox-next" class="absolute right-4 top-1/2 -translate-y-1/2 text-white w-10 h-10 flex items-center justify-center hover:text-afj-accent focus-visible:outline-2 focus-visible:outline-white" aria-label="Next image">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
  </button>
  <img id="lightbox-image" src="" alt="" class="max-w-[90vw] max-h-[90vh] object-contain" />
</div>

<script is:inline>
  (function () {
    var lightbox = document.getElementById('gallery-lightbox');
    var lightboxImage = document.getElementById('lightbox-image');
    var closeBtn = document.getElementById('lightbox-close');
    var prevBtn = document.getElementById('lightbox-prev');
    var nextBtn = document.getElementById('lightbox-next');
    var galleryItems = document.querySelectorAll('.gallery-item');
    if (!lightbox || !lightboxImage || !closeBtn) return;

    var currentIndex = 0;
    var triggerElement = null;
    var focusableElements = [closeBtn, prevBtn, nextBtn];

    function showImage(index) {
      var items = Array.from(galleryItems);
      if (index < 0) index = items.length - 1;
      if (index >= items.length) index = 0;
      currentIndex = index;
      var item = items[index];
      lightboxImage.src = item.getAttribute('data-src');
      lightboxImage.alt = item.getAttribute('data-alt');
    }

    function openLightbox(index, trigger) {
      triggerElement = trigger;
      showImage(index);
      lightbox.classList.remove('hidden');
      lightbox.classList.add('flex');
      document.body.style.overflow = 'hidden';
      // Move focus to close button
      closeBtn.focus();
    }

    function closeLightbox() {
      lightbox.classList.add('hidden');
      lightbox.classList.remove('flex');
      document.body.style.overflow = '';
      // Return focus to the gallery button that opened it
      if (triggerElement) triggerElement.focus();
    }

    galleryItems.forEach(function (item) {
      item.addEventListener('click', function () {
        var index = parseInt(this.getAttribute('data-index'), 10);
        openLightbox(index, this);
      });
    });

    closeBtn.addEventListener('click', closeLightbox);
    if (prevBtn) prevBtn.addEventListener('click', function () { showImage(currentIndex - 1); });
    if (nextBtn) nextBtn.addEventListener('click', function () { showImage(currentIndex + 1); });

    lightbox.addEventListener('click', function (e) {
      if (e.target === lightbox) closeLightbox();
    });

    // Keyboard: Escape closes, arrows navigate, Tab traps focus
    document.addEventListener('keydown', function (e) {
      if (lightbox.classList.contains('hidden')) return;

      if (e.key === 'Escape') {
        closeLightbox();
        return;
      }
      if (e.key === 'ArrowLeft') {
        showImage(currentIndex - 1);
        return;
      }
      if (e.key === 'ArrowRight') {
        showImage(currentIndex + 1);
        return;
      }

      // Focus trap: Tab/Shift+Tab cycles within lightbox
      if (e.key === 'Tab') {
        var active = document.activeElement;
        var idx = focusableElements.indexOf(active);
        if (e.shiftKey) {
          if (idx <= 0) {
            e.preventDefault();
            focusableElements[focusableElements.length - 1].focus();
          }
        } else {
          if (idx >= focusableElements.length - 1) {
            e.preventDefault();
            focusableElements[0].focus();
          }
        }
      }
    });
  })();
</script>
